{% extends "base.html" %}

{% block title %}감사 로그{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="fas fa-clipboard-list"></i> 감사 로그</h2>
                <div>
                    <button class="btn btn-outline-primary" onclick="refreshLogs()">
                        <i class="fas fa-sync-alt"></i> 새로고침
                    </button>
                </div>
            </div>

            <!-- 로그 필터 -->
            <div class="card mb-4">
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <label for="actionFilter" class="form-label">작업 유형</label>
                            <select class="form-select" id="actionFilter" onchange="filterLogs()">
                                <option value="">전체</option>
                                <option value="DELETE_TRANSACTION">거래 내역 삭제</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="userFilter" class="form-label">사용자</label>
                            <input type="text" class="form-control" id="userFilter" placeholder="사용자명 검색" onkeyup="filterLogs()">
                        </div>
                        <div class="col-md-3">
                            <label for="dateFrom" class="form-label">시작일</label>
                            <input type="date" class="form-control" id="dateFrom" onchange="filterLogs()">
                        </div>
                        <div class="col-md-3">
                            <label for="dateTo" class="form-label">종료일</label>
                            <input type="date" class="form-control" id="dateTo" onchange="filterLogs()">
                        </div>
                    </div>
                </div>
            </div>

            <!-- 로그 테이블 -->
            <div class="card">
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th>ID</th>
                                    <th>작업자</th>
                                    <th>작업 유형</th>
                                    <th>대상</th>
                                    <th>IP 주소</th>
                                    <th>작업 시간</th>
                                    <th>상세 정보</th>
                                </tr>
                            </thead>
                            <tbody id="logsTableBody">
                                <tr>
                                    <td colspan="7" class="text-center">
                                        <div class="spinner-border" role="status">
                                            <span class="visually-hidden">로딩 중...</span>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- 페이지네이션 -->
                    <nav aria-label="로그 페이지네이션">
                        <ul class="pagination justify-content-center" id="pagination">
                        </ul>
                    </nav>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 상세 정보 모달 -->
<div class="modal fade" id="detailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">상세 정보</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <pre id="detailsContent" class="bg-light p-3 rounded"></pre>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
            </div>
        </div>
    </div>
</div>

<script>
let currentPage = 1;
let allLogs = [];

// 페이지 로드 시 로그 불러오기
document.addEventListener('DOMContentLoaded', function() {
    loadAuditLogs();
});

// 감사 로그 불러오기
async function loadAuditLogs(page = 1) {
    try {
        const response = await fetch(`/api/audit-logs?page=${page}&per_page=20`);
        const data = await response.json();
        
        if (data.error) {
            showAlert('warning', data.message || data.error);
            document.getElementById('logsTableBody').innerHTML = `
                <tr>
                    <td colspan="7" class="text-center text-muted">
                        ${data.message || data.error}
                    </td>
                </tr>
            `;
            return;
        }
        
        allLogs = data.logs;
        currentPage = page;
        
        displayLogs(allLogs);
        updatePagination(data.total_pages, page);
        
    } catch (error) {
        console.error('감사 로그 로딩 실패:', error);
        showAlert('danger', '감사 로그를 불러오는데 실패했습니다.');
    }
}

// 로그 표시
function displayLogs(logs) {
    const tbody = document.getElementById('logsTableBody');
    
    if (logs.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="7" class="text-center text-muted">
                    감사 로그가 없습니다.
                </td>
            </tr>
        `;
        return;
    }
    
    tbody.innerHTML = logs.map(log => `
        <tr>
            <td>${log.id}</td>
            <td>
                <strong>${log.user_name}</strong><br>
                <small class="text-muted">${log.user_username}</small>
            </td>
            <td>
                <span class="badge bg-${getActionBadgeColor(log.action)}">
                    ${getActionText(log.action)}
                </span>
            </td>
            <td>
                ${getTargetTypeText(log.target_type)}<br>
                <small class="text-muted">ID: ${log.target_id}</small>
            </td>
            <td>
                <code>${log.ip_address || 'N/A'}</code>
            </td>
            <td>
                ${formatDateTime(log.created_at)}
            </td>
            <td>
                <button class="btn btn-sm btn-outline-info" onclick="showDetails('${log.id}')">
                    <i class="fas fa-eye"></i> 보기
                </button>
            </td>
        </tr>
    `).join('');
}

// 필터링
function filterLogs() {
    const actionFilter = document.getElementById('actionFilter').value;
    const userFilter = document.getElementById('userFilter').value.toLowerCase();
    const dateFrom = document.getElementById('dateFrom').value;
    const dateTo = document.getElementById('dateTo').value;
    
    let filteredLogs = allLogs.filter(log => {
        // 작업 유형 필터
        if (actionFilter && log.action !== actionFilter) return false;
        
        // 사용자 필터
        if (userFilter && !log.user_name.toLowerCase().includes(userFilter) && 
            !log.user_username.toLowerCase().includes(userFilter)) return false;
        
        // 날짜 필터
        if (dateFrom && log.created_at < dateFrom + 'T00:00:00') return false;
        if (dateTo && log.created_at > dateTo + 'T23:59:59') return false;
        
        return true;
    });
    
    displayLogs(filteredLogs);
}

// 상세 정보 보기
function showDetails(logId) {
    const log = allLogs.find(l => l.id == logId);
    if (!log) return;
    
    let details = '';
    if (log.details) {
        try {
            const parsed = JSON.parse(log.details);
            details = JSON.stringify(parsed, null, 2);
        } catch (e) {
            details = log.details;
        }
    }
    
    document.getElementById('detailsContent').textContent = details;
    new bootstrap.Modal(document.getElementById('detailsModal')).show();
}

// 페이지네이션 업데이트
function updatePagination(totalPages, currentPage) {
    const pagination = document.getElementById('pagination');
    let html = '';
    
    // 이전 페이지
    if (currentPage > 1) {
        html += `<li class="page-item"><a class="page-link" href="#" onclick="loadAuditLogs(${currentPage - 1})">이전</a></li>`;
    }
    
    // 페이지 번호
    for (let i = Math.max(1, currentPage - 2); i <= Math.min(totalPages, currentPage + 2); i++) {
        html += `<li class="page-item ${i === currentPage ? 'active' : ''}">
            <a class="page-link" href="#" onclick="loadAuditLogs(${i})">${i}</a>
        </li>`;
    }
    
    // 다음 페이지
    if (currentPage < totalPages) {
        html += `<li class="page-item"><a class="page-link" href="#" onclick="loadAuditLogs(${currentPage + 1})">다음</a></li>`;
    }
    
    pagination.innerHTML = html;
}

// 새로고침
function refreshLogs() {
    loadAuditLogs(currentPage);
}

// 유틸리티 함수들
function getActionText(action) {
    const actions = {
        'DELETE_TRANSACTION': '거래 내역 삭제'
    };
    return actions[action] || action;
}

function getActionBadgeColor(action) {
    const colors = {
        'DELETE_TRANSACTION': 'danger'
    };
    return colors[action] || 'secondary';
}

function getTargetTypeText(targetType) {
    const types = {
        'StockTransaction': '재고 거래 내역',
        'Product': '제품',
        'Supplier': '거래처',
        'User': '사용자'
    };
    return types[targetType] || targetType;
}

function formatDateTime(dateString) {
    if (!dateString) return 'N/A';
    
    // 서버에서 보내준 시간 문자열을 그대로 사용 (T를 공백으로만 바꿈)
    return dateString.replace('T', ' ').substring(0, 19);
}

function showAlert(type, message) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    const container = document.querySelector('.container-fluid');
    container.insertBefore(alertDiv, container.firstChild);
    
    // 5초 후 자동 제거
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.remove();
        }
    }, 5000);
}
</script>
{% endblock %}
