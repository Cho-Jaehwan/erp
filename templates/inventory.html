{% extends "base.html" %}

{% block title %}품목 관리 - 재고관리 시스템{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1>
                <i class="fas fa-boxes me-2"></i>품목 관리
            </h1>
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addProductModal">
                <i class="fas fa-plus me-2"></i>제품 추가
            </button>
        </div>
    </div>
</div>

<!-- 정렬 및 필터 컨트롤 -->
<div class="row mb-3">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-md-3">
                        <label for="sortBy" class="form-label">정렬 기준</label>
                        <select class="form-select" id="sortBy">
                            <option value="custom">사용자 정의 순서</option>
                            <option value="name">제품명</option>
                            <option value="category">카테고리</option>
                            <option value="price">가격</option>
                            <option value="stock">재고 수량</option>
                            <option value="safety_stock">안전 재고</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label for="sortOrder" class="form-label">정렬 순서</label>
                        <select class="form-select" id="sortOrder">
                            <option value="asc">오름차순</option>
                            <option value="desc">내림차순</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="categoryFilter" class="form-label">카테고리 필터</label>
                        <select class="form-select" id="categoryFilter">
                            <option value="all">전체</option>
                            {% for category in category_products.keys() %}
                            <option value="{{ category }}">{{ category }}</option>
                            {% endfor %}
                            <option value="uncategorized">미분류</option>
                        </select>
                    </div>
                    <div class="col-md-4 d-flex align-items-end">
                        <button class="btn btn-primary me-2" onclick="applySorting()">
                            <i class="fas fa-sort me-1"></i>정렬 적용
                        </button>
                        <button class="btn btn-outline-secondary me-2" onclick="resetSorting()">
                            <i class="fas fa-undo me-1"></i>초기화
                        </button>
                        <button class="btn btn-outline-warning" onclick="toggleCategoryReorder()">
                            <i class="fas fa-arrows-alt me-1"></i>카테고리 순서 변경
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 카테고리 순서 변경 컨트롤 -->
<div class="row mb-3" id="categoryReorderControls" style="display: none;">
    <div class="col-12">
        <div class="alert alert-info">
            <i class="fas fa-info-circle me-2"></i>
            카테고리 순서 변경 모드입니다. 카테고리 헤더를 드래그하여 순서를 변경할 수 있습니다.
            <button class="btn btn-sm btn-success ms-3" onclick="saveCategoryOrder()">
                <i class="fas fa-save me-1"></i>순서 저장
            </button>
            <button class="btn btn-sm btn-secondary ms-2" onclick="cancelCategoryReorder()">
                <i class="fas fa-times me-1"></i>취소
            </button>
        </div>
    </div>
</div>

<!-- 동적으로 생성될 카테고리별 테이블들 -->
<div id="productTablesContainer">
    <!-- 여기에 JavaScript로 테이블들이 동적으로 생성됩니다 -->
</div>

<!-- 제품 추가 모달 -->
<div class="modal fade" id="addProductModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">제품 추가</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="addProductForm">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="productName" class="form-label">제품명</label>
                        <input type="text" class="form-control" id="productName" name="name" required>
                    </div>
                    <div class="mb-3">
                        <label for="productCategory" class="form-label">카테고리</label>
                        <div class="input-group">
                            <select class="form-select" id="productCategory" name="category">
                                <option value="">카테고리를 선택하세요</option>
                            </select>
                            <button type="button" class="btn btn-outline-secondary" id="addNewCategoryBtn" title="새 카테고리 추가">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                        <div class="form-text">기존 카테고리를 선택하거나 새 카테고리를 추가할 수 있습니다.</div>
                    </div>
                    <div class="mb-3">
                        <label for="productPrice" class="form-label">가격</label>
                        <input type="number" class="form-control" id="productPrice" name="price" step="0.01" required>
                    </div>
                    <div class="mb-3">
                        <label for="productSafetyStock" class="form-label">안전 재고</label>
                        <input type="number" class="form-control" id="productSafetyStock" name="safety_stock" value="0" min="0">
                        <div class="form-text">재고가 이 수준 이하로 떨어지면 알림이 표시됩니다.</div>
                    </div>
                    <div class="mb-3">
                        <label for="productSafetyStockLevel" class="form-label">안전 재고 단계</label>
                        <select class="form-select" id="productSafetyStockLevel" name="safety_stock_level">
                            <option value="good">양호 (Good)</option>
                            <option value="warning">주의 (Warning)</option>
                            <option value="critical">응급 (Critical)</option>
                        </select>
                        <div class="form-text">재고 상태에 따른 알림 단계를 설정합니다.</div>
                    </div>
                    <div class="mb-3">
                        <label for="productDescription" class="form-label">설명</label>
                        <textarea class="form-control" id="productDescription" name="description" rows="3"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                    <button type="submit" class="btn btn-primary">추가</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- 제품 수정 모달 -->
<div class="modal fade" id="editProductModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">제품 수정</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="editProductForm">
                <div class="modal-body">
                    <input type="hidden" id="editProductId" name="id">
                    <div class="mb-3">
                        <label for="editProductName" class="form-label">제품명</label>
                        <input type="text" class="form-control" id="editProductName" name="name" required>
                    </div>
                    <div class="mb-3">
                        <label for="editProductCategory" class="form-label">카테고리</label>
                        <div class="input-group">
                            <select class="form-select" id="editProductCategory" name="category">
                                <option value="">카테고리를 선택하세요</option>
                            </select>
                            <button type="button" class="btn btn-outline-secondary" id="addNewCategoryEditBtn" title="새 카테고리 추가">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                        <div class="form-text">기존 카테고리를 선택하거나 새 카테고리를 추가할 수 있습니다.</div>
                    </div>
                    <div class="mb-3">
                        <label for="editProductPrice" class="form-label">가격</label>
                        <input type="number" class="form-control" id="editProductPrice" name="price" step="0.01" required>
                    </div>
                    <div class="mb-3">
                        <label for="editProductDescription" class="form-label">설명</label>
                        <textarea class="form-control" id="editProductDescription" name="description" rows="3"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                    <button type="submit" class="btn btn-primary">수정</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- 새 카테고리 추가 모달 -->
<div class="modal fade" id="addCategoryModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">새 카테고리 추가</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="addCategoryForm">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="newCategoryName" class="form-label">카테고리명</label>
                        <input type="text" class="form-control" id="newCategoryName" name="category_name" required>
                        <div class="form-text">새로운 카테고리 이름을 입력하세요.</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                    <button type="submit" class="btn btn-primary">추가</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- 안전 재고 설정 모달 -->
<div class="modal fade" id="safetyStockModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">안전 재고 설정</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="safetyStockForm">
                <div class="modal-body">
                    <input type="hidden" id="safetyStockProductId" name="product_id">
                    <div class="mb-3">
                        <label class="form-label">제품명</label>
                        <p class="form-control-plaintext" id="safetyStockProductName"></p>
                    </div>
                    <div class="mb-3">
                        <label for="safetyStockValue" class="form-label">안전 재고 수준</label>
                        <input type="number" class="form-control" id="safetyStockValue" name="safety_stock" min="0" required>
                        <div class="form-text">
                            <i class="fas fa-exclamation-triangle text-warning me-1"></i>
                            재고가 이 수준 이하로 떨어지면 알림이 표시됩니다.
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">재고 상태 분류 기준</label>
                        <div class="card bg-light">
                            <div class="card-body p-3">
                                <small class="text-muted">
                                    <strong>현재 설정값 기준 분류:</strong><br><br>
                                    
                                    <span class="badge bg-success me-2">양호</span>
                                    <strong>재고 > <span id="goodThreshold">0</span>개</strong><br>
                                    
                                    <span class="badge bg-warning me-2">주의</span>
                                    <strong><span id="warningMin">0</span>개 < 재고 ≤ <span id="warningMax">0</span>개</strong><br>
                                    
                                    <span class="badge bg-danger me-2">응급</span>
                                    <strong>재고 ≤ <span id="criticalThreshold">0</span>개</strong><br>
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                    <button type="submit" class="btn btn-primary">저장</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- 소모량 분석 모달 -->
<div class="modal fade" id="consumptionAnalysisModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-chart-line me-2"></i>소모량 분석
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="consumptionAnalysisProductId">
                
                <!-- 제품 정보 -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="card bg-primary text-white">
                            <div class="card-body">
                                <h6 class="card-title mb-2">
                                    <i class="fas fa-box me-2"></i>제품 정보
                                </h6>
                                <h4 id="consumptionProductName" class="mb-0"></h4>
                                <p class="mb-0 mt-2">
                                    <strong>현재 재고:</strong> <span id="consumptionCurrentStock" class="badge bg-light text-dark"></span>개
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 분석 설정 -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0">
                                    <i class="fas fa-cog me-2"></i>분석 설정
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <label for="analysisMonths" class="form-label">분석 기간</label>
                                        <select class="form-select" id="analysisMonths" onchange="updateConsumptionAnalysis()">
                                            <option value="3">최근 3개월</option>
                                            <option value="6" selected>최근 6개월</option>
                                            <option value="12">최근 12개월</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6 d-flex align-items-end">
                                        <button class="btn btn-primary" onclick="updateConsumptionAnalysis()">
                                            <i class="fas fa-sync-alt me-2"></i>분석 업데이트
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 분석 결과 -->
                <div id="consumptionAnalysisResults">
                    <div class="text-center py-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">분석 중...</span>
                        </div>
                        <p class="mt-3 text-muted">소모량을 분석하고 있습니다...</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<style>
/* 테이블 열 사이즈 통일 */
.category-table {
    table-layout: fixed;
}

.category-table .col-name {
    width: 15%;
}

.category-table .col-category {
    width: 10%;
}

.category-table .col-price {
    width: 10%;
}

.category-table .col-stock {
    width: 10%;
}

.category-table .col-safety {
    width: 10%;
}

.category-table .col-status {
    width: 10%;
}

.category-table .col-description {
    width: 20%;
}

.category-table .col-actions {
    width: 18%;
}

/* 정렬 컨트롤 스타일 */
.sort-controls {
    background-color: #f8f9fa;
    border-radius: 0.375rem;
    padding: 1rem;
    margin-bottom: 1rem;
}

/* 카테고리 헤더 스타일 */
.card-header h5 {
    color: #495057;
    font-weight: 600;
}

/* 테이블 호버 효과 */
.category-table tbody tr:hover {
    background-color: rgba(0, 123, 255, 0.05);
}

/* 드래그 앤 드롭 스타일 */
.draggable-row {
    cursor: move;
    transition: all 0.2s ease;
}

.draggable-row:hover {
    background-color: rgba(0, 123, 255, 0.1) !important;
}

.dragging {
    opacity: 0.5;
    transform: rotate(2deg);
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
}

.drag-over {
    border-top: 3px solid #007bff;
    background-color: rgba(0, 123, 255, 0.1);
}

.drag-handle {
    cursor: move;
    color: #6c757d;
    padding: 0 5px;
}

.drag-handle:hover {
    color: #007bff;
}

/* 순서 변경 모드 스타일 */
.reorder-mode .draggable-row {
    border-left: 3px solid #28a745;
}

.reorder-mode .drag-handle {
    color: #28a745;
}

/* 정렬 순서 컨트롤 숨기기 */
.sort-order-hidden {
    display: none !important;
}

/* 카테고리 순서 변경 모드 스타일 */
.category-reorder-mode .category-card {
    cursor: move;
    border-left: 3px solid #ffc107;
    transition: all 0.2s ease;
}

.category-reorder-mode .category-card:hover {
    background-color: rgba(255, 193, 7, 0.1);
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
}

.category-reorder-mode .category-header {
    cursor: move;
    user-select: none;
}

.category-reorder-mode .category-header:hover {
    background-color: rgba(255, 193, 7, 0.2);
}

.category-dragging {
    opacity: 0.5;
    transform: rotate(2deg);
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
    z-index: 1000;
}

.category-drag-over {
    border-top: 3px solid #ffc107;
    background-color: rgba(255, 193, 7, 0.1);
}

.category-drag-handle {
    cursor: move;
    color: #6c757d;
    margin-right: 8px;
}

.category-drag-handle:hover {
    color: #ffc107;
}
</style>

<script>
    document.getElementById('addProductForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        const productData = {
            name: formData.get('name'),
            category: formData.get('category'),
            price: parseFloat(formData.get('price')),
            safety_stock: parseInt(formData.get('safety_stock')),
            safety_stock_level: formData.get('safety_stock_level'),
            description: formData.get('description')
        };
        
        try {
            const token = localStorage.getItem('access_token');
            const response = await fetch('/inventory/add', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                credentials: 'include',
                body: JSON.stringify(productData)
            });
            
            if (response.ok) {
                alert('제품이 추가되었습니다.');
                location.reload();
            } else {
                const error = await response.json();
                alert(error.detail);
            }
        } catch (error) {
            alert('제품 추가 중 오류가 발생했습니다.');
        }
    });
    
    async function editProduct(productId) {
        try {
            // 제품 정보 조회
            const response = await fetch(`/api/products/${productId}`, {
                credentials: 'include'
            });
            
            if (!response.ok) {
                throw new Error('제품 정보를 불러올 수 없습니다.');
            }
            
            const product = await response.json();
            
            // 모달 폼에 데이터 채우기
            document.getElementById('editProductId').value = product.id;
            document.getElementById('editProductName').value = product.name;
            document.getElementById('editProductCategory').value = product.category || '';
            document.getElementById('editProductPrice').value = product.price;
            document.getElementById('editProductDescription').value = product.description || '';
            
            // 모달 열기
            const modal = new bootstrap.Modal(document.getElementById('editProductModal'));
            modal.show();
            
        } catch (error) {
            console.error('Error loading product:', error);
            alert('제품 정보를 불러오는 중 오류가 발생했습니다.');
        }
    }

    // 제품 수정 폼 제출
    document.getElementById('editProductForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        const productId = formData.get('id');
        const productData = {
            name: formData.get('name'),
            category: formData.get('category'),
            price: parseFloat(formData.get('price')),
            description: formData.get('description')
        };
        
        try {
            const response = await fetch(`/api/products/${productId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                credentials: 'include',
                body: JSON.stringify(productData)
            });
            
            if (response.ok) {
                alert('제품이 수정되었습니다.');
                bootstrap.Modal.getInstance(document.getElementById('editProductModal')).hide();
                location.reload();
            } else {
                const error = await response.json();
                alert(error.detail || '제품 수정에 실패했습니다.');
            }
        } catch (error) {
            console.error('Error updating product:', error);
            alert('제품 수정 중 오류가 발생했습니다.');
        }
    });

    // 안전 재고 설정 모달 열기
    function setSafetyStock(productId, productName, currentSafetyStock) {
        document.getElementById('safetyStockProductId').value = productId;
        document.getElementById('safetyStockProductName').textContent = productName;
        document.getElementById('safetyStockValue').value = currentSafetyStock;
        
        // 초기 기준 업데이트
        updateSafetyStockCriteria();
        
        const modal = new bootstrap.Modal(document.getElementById('safetyStockModal'));
        modal.show();
    }

    // 안전 재고 설정 저장
    document.getElementById('safetyStockForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        const productId = formData.get('product_id');
        const safetyStock = parseInt(formData.get('safety_stock'));
        
        try {
            const response = await fetch(`/api/products/${productId}/safety-stock`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                credentials: 'include',
                body: JSON.stringify({ 
                    safety_stock: safetyStock
                })
            });
            
            if (response.ok) {
                alert('안전 재고가 설정되었습니다.');
                bootstrap.Modal.getInstance(document.getElementById('safetyStockModal')).hide();
                location.reload();
            } else {
                const error = await response.json();
                alert(error.detail || '안전 재고 설정에 실패했습니다.');
            }
        } catch (error) {
            console.error('Error setting safety stock:', error);
            alert('안전 재고 설정에 실패했습니다.');
        }
    });

    // 정렬 적용 함수
    async function applySorting() {
        const sortBy = document.getElementById('sortBy').value;
        const sortOrder = document.getElementById('sortOrder').value;
        const categoryFilter = document.getElementById('categoryFilter').value;
        
        try {
            const response = await fetch(`/api/products?sort_by=${sortBy}&sort_order=${sortOrder}&category=${categoryFilter}`, {
                credentials: 'include'
            });
            
            if (!response.ok) {
                throw new Error('제품 목록을 불러올 수 없습니다.');
            }
            
            const data = await response.json();
            const products = data.products || [];
            
            // 카테고리별로 제품 그룹화
            const categoryProducts = {};
            for (const product of products) {
                const category = product.category || '미분류';
                if (!categoryProducts[category]) {
                    categoryProducts[category] = [];
                }
                categoryProducts[category].push(product);
            }
            
            // 카테고리 필터 적용
            if (categoryFilter && categoryFilter !== 'all') {
                const filteredCategoryProducts = {};
                if (categoryFilter === 'uncategorized') {
                    if (categoryProducts['미분류']) {
                        filteredCategoryProducts['미분류'] = categoryProducts['미분류'];
                    }
                } else {
                    if (categoryProducts[categoryFilter]) {
                        filteredCategoryProducts[categoryFilter] = categoryProducts[categoryFilter];
                    }
                }
                updateProductTables(filteredCategoryProducts);
            } else {
                updateProductTables(categoryProducts);
            }
            
        } catch (error) {
            console.error('Error applying sorting:', error);
            alert('정렬 적용 중 오류가 발생했습니다.');
        }
    }
    
    // 테이블 동적 업데이트 함수
    function updateProductTables(categoryProducts) {
        // 기존 카테고리 테이블들 제거
        const existingTables = document.querySelectorAll('.category-table-container');
        existingTables.forEach(table => table.remove());
        
        // 새로운 테이블들 생성
        const container = document.getElementById('productTablesContainer');
        
        for (const [category, products] of Object.entries(categoryProducts)) {
            const tableHtml = createCategoryTable(category, products);
            container.insertAdjacentHTML('beforeend', tableHtml);
        }
        
        // 드래그 앤 드롭 초기화
        setTimeout(() => {
            initializeDragAndDrop();
        }, 100);
    }
    
    // 카테고리 테이블 HTML 생성 함수
    function createCategoryTable(category, products) {
        let tableRows = '';
        for (const product of products) {
            const stockQuantity = product.stock_quantity || 0;
            const stockBadgeClass = stockQuantity > 10 ? 'bg-success' : 
                                   stockQuantity > 0 ? 'bg-warning' : 'bg-danger';
            
            let statusBadge = '';
            if (product.safety_stock && product.safety_stock > 0) {
                if (stockQuantity <= product.safety_stock) {
                    statusBadge = '<span class="badge bg-danger"><i class="fas fa-exclamation-triangle me-1"></i>응급</span>';
                } else if (stockQuantity <= product.safety_stock * 1.5) {
                    statusBadge = '<span class="badge bg-warning"><i class="fas fa-exclamation-circle me-1"></i>주의</span>';
                } else {
                    statusBadge = '<span class="badge bg-success"><i class="fas fa-check-circle me-1"></i>양호</span>';
                }
            } else {
                statusBadge = '<span class="badge bg-secondary">미설정</span>';
            }
            
            tableRows += `
                <tr class="draggable-row" data-product-id="${product.id}" draggable="true">
                    <td class="col-name">
                        <i class="fas fa-grip-vertical drag-handle me-2"></i>
                        ${product.name}
                    </td>
                    <td class="col-category">${product.category || '-'}</td>
                    <td class="col-price">₩${product.price.toLocaleString()}</td>
                    <td class="col-stock">
                        <span class="badge ${stockBadgeClass}">${stockQuantity}</span>
                    </td>
                    <td class="col-safety">
                        <span class="badge bg-info">${product.safety_stock || 0}</span>
                    </td>
                    <td class="col-status">${statusBadge}</td>
                    <td class="col-description">${product.description || '-'}</td>
                    <td class="col-actions">
                        <button class="btn btn-sm btn-outline-primary me-1" onclick="editProduct(${product.id})">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-info me-1" onclick="setSafetyStock(${product.id}, '${product.name}', ${product.safety_stock || 0})">
                            <i class="fas fa-shield-alt"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-success" onclick="showConsumptionAnalysis(${product.id}, '${product.name}', ${stockQuantity})">
                            <i class="fas fa-chart-line"></i>
                        </button>
                    </td>
                </tr>
            `;
        }
        
        return `
            <div class="row mb-4 category-table-container" data-category="${category}">
                <div class="col-12">
                    <div class="card category-card" draggable="true">
                        <div class="card-header category-header">
                            <h5 class="mb-0">
                                <i class="fas fa-arrows-alt category-drag-handle"></i>
                                <i class="fas fa-tag me-2"></i>${category}
                                <span class="badge bg-primary ms-2">${products.length}개</span>
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-hover category-table">
                                    <thead>
                                        <tr>
                                            <th class="col-name">제품명</th>
                                            <th class="col-category">카테고리</th>
                                            <th class="col-price">가격</th>
                                            <th class="col-stock">재고 수량</th>
                                            <th class="col-safety">안전 재고</th>
                                            <th class="col-status">상태</th>
                                            <th class="col-description">설명</th>
                                            <th class="col-actions">작업</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${tableRows}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }
    
    // 정렬 초기화 함수
    function resetSorting() {
        document.getElementById('sortBy').value = 'custom';
        document.getElementById('sortOrder').value = 'asc';
        document.getElementById('categoryFilter').value = 'all';
        
        // 초기 상태로 정렬 적용
        applySorting();
    }
    
    // 페이지 로드 시 초기화
    document.addEventListener('DOMContentLoaded', function() {
        // 초기 테이블 생성
        loadInitialTables();
        
        // 카테고리 드롭다운 초기화
        loadCategories();
        
        // 새 카테고리 추가 버튼 이벤트 리스너
        document.getElementById('addNewCategoryBtn').addEventListener('click', function() {
            showAddCategoryModal('productCategory');
        });
        
        document.getElementById('addNewCategoryEditBtn').addEventListener('click', function() {
            showAddCategoryModal('editProductCategory');
        });
        
        // 새 카테고리 추가 폼 이벤트 리스너
        document.getElementById('addCategoryForm').addEventListener('submit', handleAddCategory);
        
        // 안전재고 값 변경 시 실시간 업데이트
        document.getElementById('safetyStockValue').addEventListener('input', updateSafetyStockCriteria);
        
        const urlParams = new URLSearchParams(window.location.search);
        const sortBy = urlParams.get('sort_by');
        const sortOrder = urlParams.get('sort_order');
        const categoryFilter = urlParams.get('category');
        
        if (sortBy) document.getElementById('sortBy').value = sortBy;
        if (sortOrder) document.getElementById('sortOrder').value = sortOrder;
        if (categoryFilter) document.getElementById('categoryFilter').value = categoryFilter;
        
        // 정렬 기준 변경 시 이벤트 리스너
        document.getElementById('sortBy').addEventListener('change', function() {
            toggleReorderMode();
        });
        
        // 초기 상태 설정
        toggleReorderMode();
    });
    
    // 초기 테이블 로드 함수
    async function loadInitialTables() {
        try {
            const response = await fetch('/api/products', {
                credentials: 'include'
            });
            
            if (!response.ok) {
                throw new Error('제품 목록을 불러올 수 없습니다.');
            }
            
            const data = await response.json();
            const products = data.products || [];
            
            // 카테고리별로 제품 그룹화
            const categoryProducts = {};
            for (const product of products) {
                const category = product.category || '미분류';
                if (!categoryProducts[category]) {
                    categoryProducts[category] = [];
                }
                categoryProducts[category].push(product);
            }
            
            // 테이블 생성
            updateProductTables(categoryProducts);
            
        } catch (error) {
            console.error('Error loading initial tables:', error);
            alert('제품 목록을 불러오는 중 오류가 발생했습니다.');
        }
    }
    
    // 순서 변경 모드 토글
    function toggleReorderMode() {
        const sortBy = document.getElementById('sortBy').value;
        const sortOrderControl = document.getElementById('sortOrder').parentElement;
        const isCustomOrder = sortBy === 'custom';
        
        if (isCustomOrder) {
            sortOrderControl.classList.add('sort-order-hidden');
            document.body.classList.add('reorder-mode');
        } else {
            sortOrderControl.classList.remove('sort-order-hidden');
            document.body.classList.remove('reorder-mode');
        }
    }
    
    // 드래그 앤 드롭 초기화
    function initializeDragAndDrop() {
        const tables = document.querySelectorAll('.category-table tbody');
        
        tables.forEach(tbody => {
            // 기존 이벤트 리스너 제거
            tbody.removeEventListener('dragstart', handleDragStart);
            tbody.removeEventListener('dragover', handleDragOver);
            tbody.removeEventListener('drop', handleDrop);
            tbody.removeEventListener('dragend', handleDragEnd);
            
            // 새 이벤트 리스너 추가
            tbody.addEventListener('dragstart', handleDragStart);
            tbody.addEventListener('dragover', handleDragOver);
            tbody.addEventListener('drop', handleDrop);
            tbody.addEventListener('dragend', handleDragEnd);
        });
    }
    
    // 드래그 시작
    function handleDragStart(e) {
        if (!document.body.classList.contains('reorder-mode')) return;
        
        const row = e.target.closest('tr');
        if (!row || !row.classList.contains('draggable-row')) return;
        
        e.dataTransfer.effectAllowed = 'move';
        e.dataTransfer.setData('text/html', row.outerHTML);
        e.dataTransfer.setData('text/plain', row.dataset.productId);
        
        row.classList.add('dragging');
    }
    
    // 드래그 오버
    function handleDragOver(e) {
        if (!document.body.classList.contains('reorder-mode')) return;
        
        e.preventDefault();
        e.dataTransfer.dropEffect = 'move';
        
        const row = e.target.closest('tr');
        if (row && row.classList.contains('draggable-row')) {
            row.classList.add('drag-over');
        }
    }
    
    // 드롭
    function handleDrop(e) {
        if (!document.body.classList.contains('reorder-mode')) return;
        
        e.preventDefault();
        
        const draggedId = e.dataTransfer.getData('text/plain');
        const targetRow = e.target.closest('tr');
        
        if (!targetRow || !targetRow.classList.contains('draggable-row')) return;
        
        const targetId = targetRow.dataset.productId;
        
        if (draggedId === targetId) return;
        
        // 행 위치 변경
        const draggedRow = document.querySelector(`tr[data-product-id="${draggedId}"]`);
        const tbody = targetRow.parentNode;
        
        if (e.clientY < targetRow.getBoundingClientRect().top + targetRow.offsetHeight / 2) {
            tbody.insertBefore(draggedRow, targetRow);
        } else {
            tbody.insertBefore(draggedRow, targetRow.nextSibling);
        }
        
        // 순서 업데이트
        updateProductOrder(tbody);
    }
    
    // 드래그 종료
    function handleDragEnd(e) {
        const row = e.target.closest('tr');
        if (row) {
            row.classList.remove('dragging');
        }
        
        // 모든 drag-over 클래스 제거
        document.querySelectorAll('.drag-over').forEach(el => {
            el.classList.remove('drag-over');
        });
    }
    
    // 제품 순서 업데이트
    function updateProductOrder(tbody) {
        const rows = tbody.querySelectorAll('tr[data-product-id]');
        const productOrders = [];
        
        rows.forEach((row, index) => {
            const productId = row.dataset.productId;
            productOrders.push({
                id: parseInt(productId),
                sort_order: index + 1
            });
        });
        
        // 서버에 순서 업데이트 요청
        saveProductOrder(productOrders);
    }
    
    // 서버에 순서 저장
    async function saveProductOrder(productOrders) {
        try {
            const response = await fetch('/api/products/reorder', {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                credentials: 'include',
                body: JSON.stringify({
                    product_orders: productOrders
                })
            });
            
            if (!response.ok) {
                throw new Error('순서 저장에 실패했습니다.');
            }
            
            const result = await response.json();
            
        } catch (error) {
            console.error('Error saving product order:', error);
            alert('순서 저장 중 오류가 발생했습니다.');
        }
    }
    
    // 카테고리 순서 변경 모드 토글
    function toggleCategoryReorder() {
        const isReorderMode = document.body.classList.contains('category-reorder-mode');
        
        if (isReorderMode) {
            // 순서 변경 모드 해제
            document.body.classList.remove('category-reorder-mode');
            document.getElementById('categoryReorderControls').style.display = 'none';
            initializeDragAndDrop();
        } else {
            // 순서 변경 모드 활성화
            document.body.classList.add('category-reorder-mode');
            document.getElementById('categoryReorderControls').style.display = 'block';
            initializeCategoryDragAndDrop();
        }
    }
    
    // 카테고리 드래그 앤 드롭 초기화
    function initializeCategoryDragAndDrop() {
        const categoryCards = document.querySelectorAll('.category-card');
        
        categoryCards.forEach(card => {
            // 기존 이벤트 리스너 제거
            card.removeEventListener('dragstart', handleCategoryDragStart);
            card.removeEventListener('dragover', handleCategoryDragOver);
            card.removeEventListener('drop', handleCategoryDrop);
            card.removeEventListener('dragend', handleCategoryDragEnd);
            
            // 새 이벤트 리스너 추가
            card.addEventListener('dragstart', handleCategoryDragStart);
            card.addEventListener('dragover', handleCategoryDragOver);
            card.addEventListener('drop', handleCategoryDrop);
            card.addEventListener('dragend', handleCategoryDragEnd);
        });
    }
    
    // 카테고리 드래그 시작
    function handleCategoryDragStart(e) {
        if (!document.body.classList.contains('category-reorder-mode')) return;
        
        const card = e.target.closest('.category-card');
        if (!card) return;
        
        e.dataTransfer.effectAllowed = 'move';
        e.dataTransfer.setData('text/html', card.outerHTML);
        e.dataTransfer.setData('text/plain', card.closest('.category-table-container').dataset.category);
        
        card.classList.add('category-dragging');
    }
    
    // 카테고리 드래그 오버
    function handleCategoryDragOver(e) {
        if (!document.body.classList.contains('category-reorder-mode')) return;
        
        e.preventDefault();
        e.dataTransfer.dropEffect = 'move';
        
        const card = e.target.closest('.category-card');
        if (card) {
            card.classList.add('category-drag-over');
        }
    }
    
    // 카테고리 드롭
    function handleCategoryDrop(e) {
        if (!document.body.classList.contains('category-reorder-mode')) return;
        
        e.preventDefault();
        
        const draggedCategory = e.dataTransfer.getData('text/plain');
        const targetCard = e.target.closest('.category-card');
        
        if (!targetCard) return;
        
        const targetCategory = targetCard.closest('.category-table-container').dataset.category;
        
        if (draggedCategory === targetCategory) return;
        
        // 카테고리 위치 변경
        const draggedContainer = document.querySelector(`[data-category="${draggedCategory}"]`);
        const targetContainer = targetCard.closest('.category-table-container');
        
        if (e.clientY < targetCard.getBoundingClientRect().top + targetCard.offsetHeight / 2) {
            targetContainer.parentNode.insertBefore(draggedContainer, targetContainer);
        } else {
            targetContainer.parentNode.insertBefore(draggedContainer, targetContainer.nextSibling);
        }
    }
    
    // 카테고리 드래그 종료
    function handleCategoryDragEnd(e) {
        const card = e.target.closest('.category-card');
        if (card) {
            card.classList.remove('category-dragging');
        }
        
        // 모든 category-drag-over 클래스 제거
        document.querySelectorAll('.category-drag-over').forEach(el => {
            el.classList.remove('category-drag-over');
        });
    }
    
    // 카테고리 순서 저장
    async function saveCategoryOrder() {
        const categoryContainers = document.querySelectorAll('.category-table-container');
        const categoryOrders = [];
        
        categoryContainers.forEach((container, index) => {
            const categoryName = container.dataset.category;
            categoryOrders.push({
                category_name: categoryName,
                sort_order: index + 1
            });
        });
        
        try {
            const response = await fetch('/api/categories/reorder', {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                credentials: 'include',
                body: JSON.stringify({
                    category_orders: categoryOrders
                })
            });
            
            if (!response.ok) {
                throw new Error('카테고리 순서 저장에 실패했습니다.');
            }
            
            const result = await response.json();

            alert('카테고리 순서가 저장되었습니다.');
            
            // 순서 변경 모드 해제
            toggleCategoryReorder();
            
        } catch (error) {
            console.error('Error saving category order:', error);
            alert('카테고리 순서 저장 중 오류가 발생했습니다.');
        }
    }
    
    // 카테고리 순서 변경 취소
    function cancelCategoryReorder() {
        // 페이지 새로고침으로 원래 순서로 복원
        location.reload();
    }
    
    // 카테고리 목록 로드
    async function loadCategories() {
        try {
            const response = await fetch('/api/categories/order', {
                credentials: 'include'
            });
            
            if (!response.ok) {
                throw new Error('카테고리 목록을 불러올 수 없습니다.');
            }
            
            const data = await response.json();
            const categoryOrders = data.category_orders || {};
            
            // 카테고리를 순서대로 정렬
            const sortedCategories = Object.keys(categoryOrders).sort((a, b) => {
                return (categoryOrders[a] || 0) - (categoryOrders[b] || 0);
            });
            
            // 제품 추가 모달의 카테고리 드롭다운 채우기
            populateCategorySelect('productCategory', sortedCategories);
            
            // 제품 수정 모달의 카테고리 드롭다운 채우기
            populateCategorySelect('editProductCategory', sortedCategories);
            
        } catch (error) {
            console.error('Error loading categories:', error);
        }
    }
    
    // 카테고리 드롭다운 채우기
    function populateCategorySelect(selectId, categories) {
        const select = document.getElementById(selectId);
        if (!select) return;
        
        // 기존 옵션 제거 (첫 번째 옵션 제외)
        while (select.children.length > 1) {
            select.removeChild(select.lastChild);
        }
        
        // 카테고리 옵션 추가
        categories.forEach(category => {
            const option = document.createElement('option');
            option.value = category;
            option.textContent = category;
            select.appendChild(option);
        });
    }
    
    // 새 카테고리 추가 모달 표시
    function showAddCategoryModal(targetSelectId) {
        // 현재 모달에 저장할 타겟 셀렉트 ID
        document.getElementById('addCategoryModal').dataset.targetSelect = targetSelectId;
        
        // 모달 표시
        const modal = new bootstrap.Modal(document.getElementById('addCategoryModal'));
        modal.show();
        
        // 입력 필드 초기화 및 포커스
        document.getElementById('newCategoryName').value = '';
        document.getElementById('newCategoryName').focus();
    }
    
    // 새 카테고리 추가 처리
    async function handleAddCategory(event) {
        event.preventDefault();
        
        const categoryName = document.getElementById('newCategoryName').value.trim();
        const targetSelectId = document.getElementById('addCategoryModal').dataset.targetSelect;
        
        if (!categoryName) {
            alert('카테고리명을 입력해주세요.');
            return;
        }
        
        try {
            // 새 카테고리를 CategoryOrder 테이블에 추가
            const response = await fetch('/api/categories/reorder', {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                credentials: 'include',
                body: JSON.stringify({
                    category_orders: [{
                        category_name: categoryName,
                        sort_order: 999 // 마지막 순서로 추가
                    }]
                })
            });
            
            if (!response.ok) {
                throw new Error('카테고리 추가에 실패했습니다.');
            }
            
            // 카테고리 목록 다시 로드
            await loadCategories();
            
            // 타겟 셀렉트에 새 카테고리 선택
            const targetSelect = document.getElementById(targetSelectId);
            if (targetSelect) {
                targetSelect.value = categoryName;
            }
            
            // 모달 닫기
            const modal = bootstrap.Modal.getInstance(document.getElementById('addCategoryModal'));
            modal.hide();
            
            alert('새 카테고리가 추가되었습니다.');
            
        } catch (error) {
            console.error('Error adding category:', error);
            alert('카테고리 추가 중 오류가 발생했습니다.');
        }
    }
    
    // 안전재고 기준 실시간 업데이트
    function updateSafetyStockCriteria() {
        const safetyStockValue = parseInt(document.getElementById('safetyStockValue').value) || 0;
        
        // 각 단계별 임계값 계산
        const goodThreshold = safetyStockValue * 2;
        const warningMin = safetyStockValue;
        const warningMax = safetyStockValue * 2;
        const criticalThreshold = safetyStockValue;
        
        // DOM 요소 업데이트
        document.getElementById('goodThreshold').textContent = goodThreshold;
        document.getElementById('warningMin').textContent = warningMin;
        document.getElementById('warningMax').textContent = warningMax;
        document.getElementById('criticalThreshold').textContent = criticalThreshold;
    }

    // 소모량 분석 모달 열기
    function showConsumptionAnalysis(productId, productName, currentStock) {
        document.getElementById('consumptionAnalysisProductId').value = productId;
        document.getElementById('consumptionProductName').textContent = productName;
        document.getElementById('consumptionCurrentStock').textContent = currentStock;
        
        // 모달 열기
        const modal = new bootstrap.Modal(document.getElementById('consumptionAnalysisModal'));
        modal.show();
        
        // 분석 실행
        updateConsumptionAnalysis();
    }

    // 소모량 분석 업데이트
    async function updateConsumptionAnalysis() {
        const productId = document.getElementById('consumptionAnalysisProductId').value;
        const months = document.getElementById('analysisMonths').value;
        
        if (!productId) return;
        
        // 로딩 상태 표시
        document.getElementById('consumptionAnalysisResults').innerHTML = `
            <div class="text-center py-5">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">분석 중...</span>
                </div>
                <p class="mt-3 text-muted">소모량을 분석하고 있습니다...</p>
            </div>
        `;
        
        try {
            const response = await fetch(`/api/products/${productId}/consumption-analysis?months=${months}`, {
                credentials: 'include'
            });
            
            if (!response.ok) {
                throw new Error('소모량 분석 데이터를 불러올 수 없습니다.');
            }
            
            const analysisData = await response.json();
            displayConsumptionAnalysis(analysisData);
            
        } catch (error) {
            console.error('Error loading consumption analysis:', error);
            document.getElementById('consumptionAnalysisResults').innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    소모량 분석 중 오류가 발생했습니다: ${error.message}
                </div>
            `;
        }
    }

    // 소모량 분석 결과 표시
    function displayConsumptionAnalysis(data) {
        let resultsHtml = '';
        
        if (!data.has_consumption_data) {
            resultsHtml = `
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    <strong>분석 데이터 없음</strong><br>
                    최근 ${data.analysis_period_months}개월 동안 출고 내역이 없습니다.
                </div>
            `;
        } else {
            // 예상 소모 개월 계산
            let expectedMonthsHtml = '';
            if (data.expected_consumption_months !== null) {
                const expectedMonths = data.expected_consumption_months;
                let expectedBadgeClass = 'bg-success';
                let expectedText = `${expectedMonths}개월`;
                
                if (expectedMonths <= 1) {
                    expectedBadgeClass = 'bg-danger';
                    expectedText = `${expectedMonths}개월 (긴급)`;
                } else if (expectedMonths <= 3) {
                    expectedBadgeClass = 'bg-warning';
                    expectedText = `${expectedMonths}개월 (주의)`;
                }
                
                expectedMonthsHtml = `
                    <div class="col-md-4">
                        <div class="card border-success">
                            <div class="card-body text-center">
                                <h6 class="card-title text-success">
                                    <i class="fas fa-calendar-alt me-2"></i>예상 소모 개월
                                </h6>
                                <h3 class="text-success">
                                    <span class="badge ${expectedBadgeClass} fs-6">${expectedText}</span>
                                </h3>
                                <small class="text-muted">
                                    현재 재고 기준 예상 소모 기간
                                </small>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            // 월별 소모량 차트 데이터 생성
            const chartLabels = data.monthly_consumption_data.map(item => item.month);
            const chartData = data.monthly_consumption_data.map(item => item.consumption);
            
            resultsHtml = `
                <!-- 분석 요약 -->
                <div class="row mb-4">
                    <div class="col-md-4">
                        <div class="card border-primary">
                            <div class="card-body text-center">
                                <h6 class="card-title text-primary">
                                    <i class="fas fa-chart-bar me-2"></i>평균 월별 소모량
                                </h6>
                                <h3 class="text-primary">${data.average_monthly_consumption}</h3>
                                <small class="text-muted">개/월</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card border-info">
                            <div class="card-body text-center">
                                <h6 class="card-title text-info">
                                    <i class="fas fa-box me-2"></i>현재 재고
                                </h6>
                                <h3 class="text-info">${data.current_stock}</h3>
                                <small class="text-muted">개</small>
                            </div>
                        </div>
                    </div>
                    ${expectedMonthsHtml}
                </div>
                
                <!-- 월별 소모량 차트 -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0">
                                    <i class="fas fa-chart-line me-2"></i>월별 소모량 추이
                                </h6>
                            </div>
                            <div class="card-body">
                                <canvas id="consumptionChart" height="100"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 월별 소모량 상세 데이터 -->
                <div class="row">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0">
                                    <i class="fas fa-table me-2"></i>월별 소모량 상세
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-striped table-sm">
                                        <thead>
                                            <tr>
                                                <th>월</th>
                                                <th>소모량</th>
                                                <th>평균 대비</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${data.monthly_consumption_data.map(item => {
                                                const diff = item.consumption - data.average_monthly_consumption;
                                                const diffPercent = data.average_monthly_consumption > 0 ? 
                                                    ((diff / data.average_monthly_consumption) * 100).toFixed(1) : 0;
                                                const diffClass = diff > 0 ? 'text-danger' : diff < 0 ? 'text-success' : 'text-muted';
                                                const diffIcon = diff > 0 ? 'fas fa-arrow-up' : diff < 0 ? 'fas fa-arrow-down' : 'fas fa-minus';
                                                
                                                return `
                                                    <tr>
                                                        <td>${item.month}</td>
                                                        <td><strong>${item.consumption}</strong>개</td>
                                                        <td class="${diffClass}">
                                                            <i class="${diffIcon} me-1"></i>
                                                            ${diff > 0 ? '+' : ''}${diffPercent}%
                                                        </td>
                                                    </tr>
                                                `;
                                            }).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        document.getElementById('consumptionAnalysisResults').innerHTML = resultsHtml;
        
        // 차트가 있으면 렌더링
        if (data.has_consumption_data && chartLabels.length > 0) {
            renderConsumptionChart(chartLabels, chartData);
        }
    }

    // 소모량 차트 렌더링
    function renderConsumptionChart(labels, data) {
        const ctx = document.getElementById('consumptionChart');
        if (!ctx) return;
        
        // 기존 차트가 있으면 제거
        if (window.consumptionChartInstance) {
            window.consumptionChartInstance.destroy();
        }
        
        window.consumptionChartInstance = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: '월별 소모량',
                    data: data,
                    borderColor: 'rgb(54, 162, 235)',
                    backgroundColor: 'rgba(54, 162, 235, 0.1)',
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            stepSize: 1
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: false
                    }
                }
            }
        });
    }
</script>
{% endblock %}
