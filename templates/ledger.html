{% extends "base.html" %}

{% block title %}장부 - 재고관리 시스템{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="mb-4">
            <i class="fas fa-book me-2"></i>장부
        </h1>
    </div>
</div>

<!-- 필터 섹션 -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">필터 설정</h5>
            </div>
            <div class="card-body">
                <form id="filterForm" class="row g-3">
                    <div class="col-md-3">
                        <label for="dateFrom" class="form-label">시작일</label>
                        <input type="date" class="form-control" id="dateFrom" name="date_from">
                    </div>
                    <div class="col-md-3">
                        <label for="dateTo" class="form-label">종료일</label>
                        <input type="date" class="form-control" id="dateTo" name="date_to">
                    </div>
                    <div class="col-md-3">
                        <label for="supplierFilter" class="form-label">거래처</label>
                        <select class="form-select" id="supplierFilter" name="supplier_id">
                            <option value="">전체 거래처</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="transactionType" class="form-label">거래 유형</label>
                        <select class="form-select" id="transactionType" name="transaction_type">
                            <option value="">전체</option>
                            <option value="in">입고</option>
                            <option value="out">출고</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label for="productFilter" class="form-label">제품명</label>
                        <select class="form-select" id="productFilter" name="product_id">
                            <option value="">전체 제품</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label for="productSearch" class="form-label">제품명 검색</label>
                        <input type="text" class="form-control" id="productSearch" name="product_search" placeholder="제품명을 입력하세요">
                    </div>
                    <div class="col-md-3">
                        <label for="categoryFilter" class="form-label">카테고리</label>
                        <select class="form-select" id="categoryFilter" name="category">
                            <option value="">전체 카테고리</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="lotNumberSearch" class="form-label">라트 번호 검색</label>
                        <input type="text" class="form-control" id="lotNumberSearch" name="lot_number" placeholder="라트 번호를 입력하세요">
                    </div>
                    <div class="col-12">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-search me-2"></i>조회
                        </button>
                        <button type="button" class="btn btn-outline-secondary ms-2" id="resetFilter">
                            <i class="fas fa-undo me-2"></i>초기화
                        </button>
                        <button type="button" class="btn btn-outline-info ms-2" id="exportBtn">
                            <i class="fas fa-download me-2"></i>엑셀 다운로드
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- 통계 섹션 -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <h5 class="card-title text-primary">총 거래 건수</h5>
                <h3 class="text-primary" id="totalTransactions">-</h3>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <h5 class="card-title text-success">총 입고 수량</h5>
                <h3 class="text-success" id="totalInQuantity">-</h3>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <h5 class="card-title text-warning">총 출고 수량</h5>
                <h3 class="text-warning" id="totalOutQuantity">-</h3>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <h5 class="card-title text-info">거래처 수</h5>
                <h3 class="text-info" id="totalSuppliers">-</h3>
            </div>
        </div>
    </div>
</div>

<!-- 거래 내역 테이블 -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">거래 내역</h5>
                <div class="btn-group btn-group-sm" role="group">
                    <input type="radio" class="btn-check" name="viewMode" id="tableView" value="table" checked>
                    <label class="btn btn-outline-primary" for="tableView">테이블</label>
                    
                    <input type="radio" class="btn-check" name="viewMode" id="cardView" value="card">
                    <label class="btn btn-outline-primary" for="cardView">카드</label>
                </div>
            </div>
            <div class="card-body">
                <!-- 테이블 뷰 -->
                <div id="tableView" class="view-content">
                    <div class="table-responsive">
                        <table class="table table-hover" id="transactionsTable">
                            <thead class="table-light">
                                <tr>
                                    <th>거래일시</th>
                                    <th>제품명</th>
                                    <th>거래 유형</th>
                                    <th>수량</th>
                                    <th>LOT 번호</th>
                                    <th>거래처</th>
                                    <th>작업자</th>
                                    <th>비고</th>
                                    <th>작업</th>
                                </tr>
                            </thead>
                            <tbody id="transactionsTableBody">
                                <!-- 동적으로 로드될 데이터 -->
                            </tbody>
                        </table>
                    </div>
                    <nav aria-label="거래 내역 페이지네이션">
                        <ul class="pagination justify-content-center" id="pagination">
                            <!-- 동적으로 생성될 페이지네이션 -->
                        </ul>
                    </nav>
                </div>

                <!-- 카드 뷰 -->
                <div id="cardView" class="view-content" style="display: none;">
                    <div class="row" id="transactionsCardBody">
                        <!-- 동적으로 로드될 카드들 -->
                    </div>
                </div>

                <!-- 로딩 표시 -->
                <div id="loadingIndicator" class="text-center py-4" style="display: none;">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">로딩 중...</span>
                    </div>
                    <p class="mt-2">데이터를 불러오는 중...</p>
                </div>

                <!-- 데이터 없음 표시 -->
                <div id="noDataIndicator" class="text-center py-5" style="display: none;">
                    <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                    <h5 class="text-muted">거래 내역이 없습니다</h5>
                    <p class="text-muted">선택한 조건에 해당하는 거래 내역이 없습니다.</p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // 전역 변수
    let currentPage = 1;
    let totalPages = 1;
    let currentFilters = {};
    let allSuppliers = [];
    let allProducts = [];
    let currentUser = null;

    // 페이지 로드 시 초기화
    document.addEventListener('DOMContentLoaded', async function() {
        setupDefaultDateRange();
        await loadCurrentUser();
        loadSuppliers();
        loadProducts();
        loadCategories();
        setupEventListeners();
        loadTransactions();
    });

    // 현재 사용자 정보 로드
    async function loadCurrentUser() {
        try {
            const response = await fetch('/api/user/me', {
                credentials: 'include'
            });
            
            if (response.ok) {
                currentUser = await response.json();
            }
        } catch (error) {
            console.error('Error loading current user:', error);
        }
    }

    // 기본 날짜 범위 설정 (최근 1개월)
    function setupDefaultDateRange() {
        const today = new Date();
        const oneMonthAgo = new Date();
        oneMonthAgo.setMonth(today.getMonth() - 1);

        // 날짜를 YYYY-MM-DD 형식으로 포맷
        const formatDate = (date) => {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        };

        const fromDate = formatDate(oneMonthAgo);
        const toDate = formatDate(today);
        
        
        document.getElementById('dateFrom').value = fromDate;
        document.getElementById('dateTo').value = toDate;
        
        // 설정된 값 확인

        
        // 임시로 더 넓은 범위 설정 (2024년부터 현재까지)
        document.getElementById('dateFrom').value = '2024-01-01';
        document.getElementById('dateTo').value = toDate;
    }

    // 거래처 목록 로드
    async function loadSuppliers() {
        try {
            const response = await fetch('/api/suppliers', {
                credentials: 'include'
            });
            
            if (response.ok) {
                const data = await response.json();
                allSuppliers = data.suppliers || [];
                const supplierSelect = document.getElementById('supplierFilter');
                
                allSuppliers.forEach(supplier => {
                    const option = document.createElement('option');
                    option.value = supplier.id;
                    option.textContent = supplier.name;
                    supplierSelect.appendChild(option);
                });
            }
        } catch (error) {
            console.error('Error loading suppliers:', error);
        }
    }

    // 제품 목록 로드
    async function loadProducts() {
        try {
            const response = await fetch('/api/products', {
                credentials: 'include'
            });
            
            if (response.ok) {
                const data = await response.json();
                allProducts = data.products || [];
                const productSelect = document.getElementById('productFilter');
                
                allProducts.forEach(product => {
                    const option = document.createElement('option');
                    option.value = product.id;
                    option.textContent = product.name;
                    productSelect.appendChild(option);
                });
            }
        } catch (error) {
            console.error('Error loading products:', error);
        }
    }

    // 카테고리 목록 로드
    async function loadCategories() {
        try {
            const response = await fetch('/api/categories', {
                credentials: 'include'
            });
            
            if (response.ok) {
                const categories = await response.json();
                const categorySelect = document.getElementById('categoryFilter');
                
                // 기존 옵션 유지 (전체 카테고리)
                const allOption = categorySelect.querySelector('option[value=""]');
                categorySelect.innerHTML = '';
                categorySelect.appendChild(allOption);
                
                categories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category;
                    option.textContent = category;
                    categorySelect.appendChild(option);
                });
            }
        } catch (error) {
            console.error('Error loading categories:', error);
        }
    }

    // 이벤트 리스너 설정
    function setupEventListeners() {
        // 필터 폼 제출
        document.getElementById('filterForm').addEventListener('submit', function(e) {
            e.preventDefault();
            currentPage = 1;
            loadTransactions();
        });

        // 필터 초기화
        document.getElementById('resetFilter').addEventListener('click', function() {
            setupDefaultDateRange();
            document.getElementById('supplierFilter').value = '';
            document.getElementById('transactionType').value = '';
            document.getElementById('productFilter').value = '';
            document.getElementById('productSearch').value = '';
            document.getElementById('categoryFilter').value = '';
            document.getElementById('lotNumberSearch').value = '';
            currentPage = 1;
            loadTransactions();
        });

        // 뷰 모드 변경
        document.querySelectorAll('input[name="viewMode"]').forEach(radio => {
            radio.addEventListener('change', function() {
                if (this.checked) {
                    const tableView = document.getElementById('tableView');
                    const cardView = document.getElementById('cardView');
                    
                    if (this.value === 'table') {
                        tableView.style.display = 'block';
                        cardView.style.display = 'none';
                    } else {
                        tableView.style.display = 'none';
                        cardView.style.display = 'block';
                    }
                }
            });
        });

        // 엑셀 다운로드
        document.getElementById('exportBtn').addEventListener('click', exportToExcel);

        // 제품명 검색 기능
        document.getElementById('productSearch').addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase();
            const productSelect = document.getElementById('productFilter');
            const options = productSelect.querySelectorAll('option');
            
            // 모든 옵션을 숨김
            options.forEach(option => {
                if (option.value === '') {
                    option.style.display = 'block'; // "전체 제품" 옵션은 항상 표시
                } else {
                    option.style.display = 'none';
                }
            });
            
            // 검색어와 일치하는 옵션만 표시
            if (searchTerm) {
                options.forEach(option => {
                    if (option.value !== '' && option.textContent.toLowerCase().includes(searchTerm)) {
                        option.style.display = 'block';
                    }
                });
            } else {
                // 검색어가 없으면 모든 옵션 표시
                options.forEach(option => {
                    option.style.display = 'block';
                });
            }
        });
    }

    // 거래 내역 로드
    async function loadTransactions() {
        showLoading();
        
        // 사용자 정보가 로드되지 않았다면 다시 시도
        if (!currentUser) {
            console.log('사용자 정보가 없어서 다시 로드 시도');
            await loadCurrentUser();
        }
        
        const formData = new FormData(document.getElementById('filterForm'));
        currentFilters = {
            date_from: formData.get('date_from'),
            date_to: formData.get('date_to'),
            supplier_id: formData.get('supplier_id'),
            transaction_type: formData.get('transaction_type'),
            product_id: formData.get('product_id'),
            product_search: formData.get('product_search'),
            category: formData.get('category'),
            lot_number: formData.get('lot_number'),
            page: currentPage
        };

        try {
            const queryParams = new URLSearchParams();
            Object.entries(currentFilters).forEach(([key, value]) => {
                if (value) queryParams.append(key, value);
            });

            const response = await fetch(`/api/transactions/filtered?${queryParams}`, {
                credentials: 'include'
            });

            if (response.ok) {
                const data = await response.json();
                displayTransactions(data);
                updateStatistics(data);
                updatePagination(data);
            } else {
                const errorText = await response.text();
                console.error('API 오류 응답:', errorText);
                showError('거래 내역을 불러오는데 실패했습니다.');
            }
        } catch (error) {
            console.error('Error loading transactions:', error);
            showError('거래 내역을 불러오는데 실패했습니다.');
        }
    }

    // 거래 내역 표시
    function displayTransactions(data) {
        hideLoading();
        

        
        if (!data.recent_transactions || data.recent_transactions.length === 0) {
            showNoData();
            return;
        }

        
        const tableView = document.getElementById('tableView');
        const cardView = document.getElementById('cardView');
        
        if (tableView.style.display !== 'none') {
            displayTableView(data.recent_transactions);
        } else {
            displayCardView(data.recent_transactions);
        }
    }

    // 테이블 뷰 표시
    function displayTableView(transactions) {

        
        const tbody = document.getElementById('transactionsTableBody');
        tbody.innerHTML = '';

        transactions.forEach((transaction, index) => {

            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${formatDateTime(transaction.created_at)}</td>
                <td>${transaction.product ? transaction.product.name : 'N/A'}</td>
                <td>
                    <span class="badge ${transaction.transaction_type === 'in' ? 'bg-success' : 'bg-warning'}">
                        ${transaction.transaction_type === 'in' ? '입고' : '출고'}
                    </span>
                </td>
                <td class="text-end">${formatNumber(transaction.quantity)}</td>
                <td>${transaction.lot_number || '-'}</td>
                <td>${transaction.supplier ? transaction.supplier.name : '-'}</td>
                <td>${transaction.user ? transaction.user.full_name : 'N/A'}</td>
                <td>${transaction.notes || '-'}</td>
                <td>
                    ${currentUser && currentUser.is_admin ? 
                        `<button class="btn btn-sm btn-outline-danger" onclick="deleteTransaction(${transaction.id})" title="거래 내역 삭제">
                            <i class="fas fa-trash"></i>
                        </button>` : 
                        '<span class="text-muted">-</span>'
                    }
                </td>
            `;
            tbody.appendChild(row);
        });
    }

    // 카드 뷰 표시
    function displayCardView(transactions) {
        
        const cardBody = document.getElementById('transactionsCardBody');
        cardBody.innerHTML = '';

        transactions.forEach(transaction => {

            const card = document.createElement('div');
            card.className = 'col-md-6 col-lg-4 mb-3';
            card.innerHTML = `
                <div class="card h-100">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span class="badge ${transaction.transaction_type === 'in' ? 'bg-success' : 'bg-warning'}">
                            ${transaction.transaction_type === 'in' ? '입고' : '출고'}
                        </span>
                        <div class="d-flex align-items-center gap-2">
                            <small class="text-muted">${formatDateTime(transaction.created_at)}</small>
                            ${currentUser && currentUser.is_admin ? 
                                `<button class="btn btn-sm btn-outline-danger" onclick="deleteTransaction(${transaction.id})" title="거래 내역 삭제">
                                    <i class="fas fa-trash"></i>
                                </button>` : 
                                ''
                            }
                        </div>
                    </div>
                    <div class="card-body">
                        <h6 class="card-title">${transaction.product.name}</h6>
                        <p class="card-text">
                            <strong>수량:</strong> ${formatNumber(transaction.quantity)}<br>
                            <strong>LOT:</strong> ${transaction.lot_number || '-'}<br>
                            <strong>거래처:</strong> ${transaction.supplier ? transaction.supplier.name : '-'}<br>
                            <strong>작업자:</strong> ${transaction.user.full_name}
                        </p>
                        ${transaction.notes ? `<p class="card-text"><small class="text-muted">${transaction.notes}</small></p>` : ''}
                    </div>
                </div>
            `;
            cardBody.appendChild(card);
        });
        console.log('카드 뷰 표시 완료');
    }

    // 통계 업데이트
    function updateStatistics(data) {
        document.getElementById('totalTransactions').textContent = formatNumber(data.total_transactions || 0);
        document.getElementById('totalInQuantity').textContent = formatNumber(data.total_in_quantity || 0);
        document.getElementById('totalOutQuantity').textContent = formatNumber(data.total_out_quantity || 0);
        document.getElementById('totalSuppliers').textContent = formatNumber(data.total_suppliers || 0);
    }

    // 페이지네이션 업데이트
    function updatePagination(data) {
        const pagination = document.getElementById('pagination');
        pagination.innerHTML = '';

        if (data.total_pages <= 1) return;

        // 이전 페이지
        const prevLi = document.createElement('li');
        prevLi.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
        prevLi.innerHTML = `<a class="page-link" href="#" data-page="${currentPage - 1}">이전</a>`;
        pagination.appendChild(prevLi);

        // 페이지 번호들
        for (let i = 1; i <= data.total_pages; i++) {
            const li = document.createElement('li');
            li.className = `page-item ${i === currentPage ? 'active' : ''}`;
            li.innerHTML = `<a class="page-link" href="#" data-page="${i}">${i}</a>`;
            pagination.appendChild(li);
        }

        // 다음 페이지
        const nextLi = document.createElement('li');
        nextLi.className = `page-item ${currentPage === data.total_pages ? 'disabled' : ''}`;
        nextLi.innerHTML = `<a class="page-link" href="#" data-page="${currentPage + 1}">다음</a>`;
        pagination.appendChild(nextLi);

        // 페이지 클릭 이벤트
        pagination.addEventListener('click', function(e) {
            e.preventDefault();
            if (e.target.classList.contains('page-link')) {
                const page = parseInt(e.target.dataset.page);
                if (page >= 1 && page <= data.total_pages && page !== currentPage) {
                    currentPage = page;
                    loadTransactions();
                }
            }
        });
    }

    // 로딩 표시
    function showLoading() {
        document.getElementById('loadingIndicator').style.display = 'block';
        document.getElementById('transactionsTableBody').innerHTML = '';
        document.getElementById('transactionsCardBody').innerHTML = '';
        document.getElementById('noDataIndicator').style.display = 'none';
    }

    // 로딩 숨기기
    function hideLoading() {
        document.getElementById('loadingIndicator').style.display = 'none';
    }

    // 데이터 없음 표시
    function showNoData() {
        hideLoading();
        document.getElementById('noDataIndicator').style.display = 'block';
        document.getElementById('transactionsTableBody').innerHTML = '';
        document.getElementById('transactionsCardBody').innerHTML = '';
    }

    // 오류 표시
    function showError(message) {
        hideLoading();
        alert(message);
    }

    // 엑셀 다운로드
    function exportToExcel() {
        const queryParams = new URLSearchParams();
        Object.entries(currentFilters).forEach(([key, value]) => {
            if (value && key !== 'page') queryParams.append(key, value);
        });

        const url = `/api/transactions/export?${queryParams}`;
        window.open(url, '_blank');
    }

    // 유틸리티 함수들
    function formatDateTime(dateString) {
        const date = new Date(dateString);
        return date.toLocaleDateString('ko-KR', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit'
        });
    }

    function formatNumber(num) {
        return new Intl.NumberFormat('ko-KR').format(num);
    }

    // 거래 내역 삭제
    async function deleteTransaction(transactionId) {
        // 관리자 권한 확인
        if (!currentUser || !currentUser.is_admin) {
            alert('관리자 권한이 필요합니다.');
            return;
        }

        if (!confirm('정말로 이 거래 내역을 삭제하시겠습니까?\n\n주의: 삭제된 거래 내역은 복구할 수 없습니다.')) {
            return;
        }

        try {
            const response = await fetch(`/api/transactions/${transactionId}`, {
                method: 'DELETE',
                credentials: 'include'
            });

            if (response.ok) {
                alert('거래 내역이 삭제되었습니다.');
                // 현재 페이지의 거래 내역 다시 로드
                loadTransactions();
            } else {
                let errorMessage = '알 수 없는 오류가 발생했습니다.';
                try {
                    const errorData = await response.json();
                    errorMessage = errorData.detail || errorMessage;
                } catch (e) {
                    // JSON 파싱 실패 시 응답 텍스트 사용
                    const errorText = await response.text();
                    errorMessage = errorText || errorMessage;
                }
                alert(`삭제 실패: ${errorMessage}`);
            }
        } catch (error) {
            console.error('Error deleting transaction:', error);
            alert('거래 내역 삭제 중 오류가 발생했습니다.');
        }
    }
</script>
{% endblock %}
