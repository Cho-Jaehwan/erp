{% extends "base.html" %}

{% block title %}주문관리{% endblock %}

{% block content %}
<style>
/* 상태 변경 팝업 스타일 */
.status-popup {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: white;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.175);
    z-index: 1060;
    min-width: 200px;
    padding: 0;
    display: none;
}

.status-popup.show {
    display: block;
    animation: popupFadeIn 0.2s ease-out;
}

.status-popup-header {
    background: #f8f9fa;
    padding: 12px 16px;
    border-bottom: 1px solid #dee2e6;
    border-radius: 8px 8px 0 0;
    font-weight: 600;
    color: #495057;
}

.status-popup-body {
    padding: 0;
}

.status-option {
    display: block;
    width: 100%;
    padding: 12px 16px;
    border: none;
    background: none;
    text-align: left;
    color: #495057;
    cursor: pointer;
    transition: background-color 0.15s ease;
    border-bottom: 1px solid #f1f3f4;
}

.status-option:last-child {
    border-bottom: none;
    border-radius: 0 0 8px 8px;
}

.status-option:hover {
    background-color: #f8f9fa;
}

.status-option.danger {
    color: #dc3545;
}

.status-option.danger:hover {
    background-color: #f8d7da;
}

/* 팝업 오버레이 */
.popup-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.1);
    z-index: 1059;
    display: none;
}

.popup-overlay.show {
    display: block;
}

/* 애니메이션 */
@keyframes popupFadeIn {
    from {
        opacity: 0;
        transform: translate(-50%, -50%) scale(0.9);
    }
    to {
        opacity: 1;
        transform: translate(-50%, -50%) scale(1);
    }
}

/* 모든 컨테이너 오버플로우 설정 */
.container-fluid,
.card,
.card-body,
.table-responsive,
.table,
.table td,
.table th {
    overflow: visible !important;
}
</style>
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="fas fa-shopping-cart"></i> 주문관리</h2>
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createOrderModal">
                    <i class="fas fa-plus"></i> 새 주문
                </button>
            </div>

            <!-- 필터 섹션 -->
            <div class="card mb-4">
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-3">
                            <label for="supplierFilter" class="form-label">거래처</label>
                            <select class="form-select" id="supplierFilter">
                                <option value="">전체</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label for="statusFilter" class="form-label">주문상태</label>
                            <select class="form-select" id="statusFilter">
                                <option value="">전체</option>
                                <option value="pending">대기중</option>
                                <option value="confirmed">확정</option>
                                <option value="in_progress">진행중</option>
                                <option value="completed">완료</option>
                                <option value="cancelled">취소</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label for="priorityFilter" class="form-label">우선순위</label>
                            <select class="form-select" id="priorityFilter">
                                <option value="">전체</option>
                                <option value="low">낮음</option>
                                <option value="normal">보통</option>
                                <option value="high">높음</option>
                                <option value="urgent">긴급</option>
                            </select>
                        </div>
                        <div class="col-md-3 d-flex align-items-end">
                            <button class="btn btn-outline-primary me-2" onclick="applyFilters()">
                                <i class="fas fa-filter"></i> 필터적용
                            </button>
                            <button class="btn btn-outline-secondary" onclick="clearFilters()">
                                <i class="fas fa-times"></i> 초기화
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 주문 목록 -->
            <div class="card">
                <div class="card-body">
                    <div class="table-responsive" style="overflow: visible;">
                        <table class="table table-hover" id="ordersTable">
                            <thead class="table-dark">
                                <tr>
                                    <th>주문번호</th>
                                    <th>거래처</th>
                                    <th>총금액</th>
                                    <th>납품방식</th>
                                    <th>주문상태</th>
                                    <th>우선순위</th>
                                    <th>주문일</th>
                                    <th>납기일</th>
                                    <th style="min-width: 200px;">작업</th>
                                </tr>
                            </thead>
                            <tbody id="ordersTableBody">
                                <!-- 주문 데이터가 여기에 동적으로 로드됩니다 -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 새 주문 생성 모달 -->
<div class="modal fade" id="createOrderModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">새 주문 생성</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="createOrderForm">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label for="supplierSelect" class="form-label">거래처 *</label>
                            <select class="form-select" id="supplierSelect" required>
                                <option value="">거래처를 선택하세요</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="deliveryDate" class="form-label">요청일</label>
                            <input type="date" class="form-control" id="deliveryDate">
                        </div>
                        <div class="col-md-3">
                            <label for="prioritySelect" class="form-label">우선순위</label>
                            <select class="form-select" id="prioritySelect">
                                <option value="normal">보통</option>
                                <option value="low">낮음</option>
                                <option value="high">높음</option>
                                <option value="urgent">긴급</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="paymentTypeSelect" class="form-label">거래방식</label>
                            <select class="form-select" id="paymentTypeSelect">
                                <option value="advance">선납</option>
                                <option value="post">후납</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="currencySelect" class="form-label">통화</label>
                            <select class="form-select" id="currencySelect">
                                <option value="KRW">원화 (KRW)</option>
                            </select>
                        </div>
                        <div class="col-12">
                            <label for="orderNotes" class="form-label">비고</label>
                            <textarea class="form-control" id="orderNotes" rows="2"></textarea>
                        </div>
                    </div>

                    <hr>
                    <h6>주문 상품</h6>
                    <div class="table-responsive">
                        <table class="table table-sm" id="orderItemsTable">
                            <thead>
                                <tr>
                                    <th>제품</th>
                                    <th>수량</th>
                                    <th>단가</th>
                                    <th>총가격</th>
                                    <th>비고</th>
                                    <th>작업</th>
                                </tr>
                            </thead>
                            <tbody id="orderItemsTableBody">
                                <tr id="emptyRow">
                                    <td colspan="6" class="text-center text-muted">
                                        주문 상품을 추가하세요
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <button type="button" class="btn btn-outline-primary btn-sm" onclick="addOrderItem()">
                        <i class="fas fa-plus"></i> 상품 추가
                    </button>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                <button type="button" class="btn btn-primary" onclick="createOrder()">주문 생성</button>
            </div>
        </div>
    </div>
</div>

<!-- 주문 상세 모달 -->
<div class="modal fade" id="orderDetailModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">주문 상세</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="orderDetailContent">
                <!-- 주문 상세 내용이 여기에 동적으로 로드됩니다 -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
            </div>
        </div>
    </div>
</div>

<!-- 상태 변경 팝업 -->
<div class="popup-overlay" id="statusPopupOverlay"></div>
<div class="status-popup" id="statusPopup">
    <div class="status-popup-header">
        <i class="fas fa-cog me-2"></i>주문 상태 변경
    </div>
    <div class="status-popup-body" id="statusPopupBody">
        <!-- 동적으로 생성됩니다 -->
    </div>
</div>

<!-- 공급 일정 추가 모달 -->
<div class="modal fade" id="supplyScheduleModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">공급 일정 추가</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="supplyScheduleForm">
                    <input type="hidden" id="supplyScheduleOrderId">
                    
                    
                    <div class="row mb-3">
                        <div class="col-12">
                            <div class="d-flex justify-content-between align-items-center">
                                <h6 class="mb-0">공급 일정 목록</h6>
                                <button type="button" class="btn btn-outline-primary btn-sm" onclick="addScheduleRow()">
                                    <i class="fas fa-plus"></i> 일정 추가
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="table-responsive">
                        <table class="table table-sm table-bordered">
                            <thead class="table-light">
                                <tr>
                                    <th>공급 예정일</th>
                                    <th>비고</th>
                                    <th>품목별 계획 수량</th>
                                    <th>작업</th>
                                </tr>
                            </thead>
                            <tbody id="scheduleRowsTableBody">
                                <!-- 동적으로 추가될 일정 행들 -->
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i>
                        <strong>안내:</strong> 여러 개의 공급 일정을 추가할 수 있습니다. 각 일정별로 품목별 계획 수량을 설정하세요.
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                <button type="button" class="btn btn-primary" onclick="addSupplySchedule()">공급 일정 추가</button>
            </div>
        </div>
    </div>
</div>


<script>
let orders = [];
let suppliers = [];
let products = [];
let currentOrderId = null;

// 페이지 로드 시 초기화
document.addEventListener('DOMContentLoaded', function() {
    loadSuppliers();
    loadProducts();
    loadOrders();
    
    // 팝업 오버레이 클릭 시 팝업 닫기
    document.getElementById('statusPopupOverlay').addEventListener('click', function() {
        hideStatusPopup();
    });
});

// 거래처 목록 로드
async function loadSuppliers() {
    try {
        const response = await fetch('/api/suppliers');
        const data = await response.json();
        suppliers = data.suppliers || [];
        
        // 필터용 거래처 목록 업데이트
        const supplierFilter = document.getElementById('supplierFilter');
        const supplierSelect = document.getElementById('supplierSelect');
        
        [supplierFilter, supplierSelect].forEach(select => {
            select.innerHTML = '<option value="">전체</option>';
            suppliers.forEach(supplier => {
                const option = document.createElement('option');
                option.value = supplier.id;
                option.textContent = supplier.name;
                select.appendChild(option);
            });
        });
    } catch (error) {
        console.error('거래처 로드 실패:', error);
    }
}

// 제품 목록 로드
async function loadProducts() {
    try {
        const response = await fetch('/api/products');
        const data = await response.json();
        products = data.products || [];
    } catch (error) {
        console.error('제품 로드 실패:', error);
        products = [];
    }
}

// 주문 목록 로드
async function loadOrders() {
    try {
        const response = await fetch('/api/orders');
        const data = await response.json();
        orders = data.orders || [];
        renderOrdersTable();
    } catch (error) {
        console.error('주문 로드 실패:', error);
    }
}

// 주문 테이블 렌더링
function renderOrdersTable() {
    const tbody = document.getElementById('ordersTableBody');
    tbody.innerHTML = '';
    
    if (orders.length === 0) {
        tbody.innerHTML = '<tr><td colspan="9" class="text-center text-muted">주문이 없습니다</td></tr>';
        return;
    }
    
    orders.forEach(order => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td><strong>${order.order_number}</strong></td>
            <td>${order.supplier_name}</td>
            <td>${formatCurrency(order.total_amount, order.currency)}</td>
            <td><span class="badge ${getPaymentTypeBadgeClass(order.payment_type || 'post')}">${getPaymentTypeText(order.payment_type || 'post')}</span></td>
            <td><span class="badge ${getStatusBadgeClass(order.status)}">${getStatusText(order.status)}</span></td>
            <td><span class="badge ${getPriorityBadgeClass(order.priority)}">${getPriorityText(order.priority)}</span></td>
            <td>${formatDate(order.order_date)}</td>
            <td>${order.delivery_date ? formatDate(order.delivery_date) : '-'}</td>
            <td>
                <div class="btn-group btn-group-sm">
                    <button class="btn btn-outline-primary" onclick="viewOrderDetail(${order.id})" title="상세보기">
                        <i class="fas fa-eye"></i>
                    </button>
                                    <button class="btn btn-outline-info" onclick="addSupplyScheduleModal(${order.id})" title="공급일정">
                                        <i class="fas fa-calendar"></i>
                                    </button>
                                    <button class="btn btn-outline-secondary btn-sm ${order.status === 'completed' ? 'disabled' : ''}" 
                                            onclick="${order.status === 'completed' ? 'alert(\'완료된 주문은 상태를 변경할 수 없습니다.\')' : `showStatusPopup(${order.id})`}" 
                                            title="${order.status === 'completed' ? '완료된 주문은 상태 변경 불가' : '상태변경'}">
                                        <i class="fas fa-cog"></i>
                                    </button>
                                </div>
                            </td>
        `;
        tbody.appendChild(row);
    });
}

// 필터 적용
function applyFilters() {
    const supplierId = document.getElementById('supplierFilter').value;
    const status = document.getElementById('statusFilter').value;
    const priority = document.getElementById('priorityFilter').value;
    
    let filteredOrders = orders;
    
    if (supplierId) {
        filteredOrders = filteredOrders.filter(order => order.supplier_id == supplierId);
    }
    if (status) {
        filteredOrders = filteredOrders.filter(order => order.status === status);
    }
    if (priority) {
        filteredOrders = filteredOrders.filter(order => order.priority === priority);
    }
    
    // 임시로 필터된 주문을 렌더링
    const originalOrders = orders;
    orders = filteredOrders;
    renderOrdersTable();
    orders = originalOrders;
}

// 필터 초기화
function clearFilters() {
    document.getElementById('supplierFilter').value = '';
    document.getElementById('statusFilter').value = '';
    document.getElementById('priorityFilter').value = '';
    renderOrdersTable();
}

// 주문 상세 보기
async function viewOrderDetail(orderId) {
    try {
        const response = await fetch(`/api/orders/${orderId}`);
        const data = await response.json();
        
        // 공급 일정 조회
        let supplySchedules = [];
        try {
            const scheduleResponse = await fetch(`/api/orders/${orderId}/supply-schedules`);
            if (scheduleResponse.ok) {
                const scheduleData = await scheduleResponse.json();
                supplySchedules = scheduleData.schedules || [];
            }
        } catch (error) {
            console.error('공급 일정 로드 실패:', error);
        }
        
        const content = document.getElementById('orderDetailContent');
        content.innerHTML = `
            <div class="row">
                <div class="col-md-6">
                    <h6>주문 정보</h6>
                    <table class="table table-sm">
                        <tr><td>주문번호</td><td><strong>${data.order.order_number}</strong></td></tr>
                        <tr><td>거래처</td><td>${data.order.supplier_name}</td></tr>
                        <tr><td>총금액</td><td>${formatCurrency(data.order.total_amount, data.order.currency)}</td></tr>
                        <tr><td>납품방식</td><td><span class="badge ${getPaymentTypeBadgeClass(data.order.payment_type || 'post')}">${getPaymentTypeText(data.order.payment_type || 'post')}</span></td></tr>
                        <tr><td>주문상태</td><td><span class="badge ${getStatusBadgeClass(data.order.status)}">${getStatusText(data.order.status)}</span></td></tr>
                        <tr><td>우선순위</td><td><span class="badge ${getPriorityBadgeClass(data.order.priority)}">${getPriorityText(data.order.priority)}</span></td></tr>
                        <tr><td>주문일</td><td>${formatDate(data.order.order_date)}</td></tr>
                        <tr><td>납기일</td><td>${data.order.delivery_date ? formatDate(data.order.delivery_date) : '-'}</td></tr>
                        <tr><td>비고</td><td>${data.order.notes || '-'}</td></tr>
                    </table>
                </div>
                <div class="col-md-6">
                    <h6>주문 상품</h6>
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>제품명</th>
                                    <th>수량</th>
                                    <th>단가</th>
                                    <th>총가격</th>
                                    <th>공급수량</th>
                                    <th>잔여수량</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${data.items.map(item => `
                                    <tr>
                                        <td>${item.product_name}</td>
                                        <td>${item.quantity}</td>
                                        <td>${formatCurrency(item.unit_price, data.order.currency)}</td>
                                        <td>${formatCurrency(item.total_price, data.order.currency)}</td>
                                        <td>${item.supplied_quantity}</td>
                                        <td>${item.remaining_quantity}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            <hr>
            <div class="row">
                <div class="col-12">
                    <h6>공급 일정</h6>
                    ${supplySchedules.length > 0 ? `
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>공급 예정일</th>
                                        <th>계획 수량</th>
                                        <th>실제 수량</th>
                                        <th>상태</th>
                                        <th>비고</th>
                                        <th>생성일</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${supplySchedules.map(schedule => `
                                        <tr>
                                            <td>${formatDate(schedule.schedule_date)}</td>
                                            <td>${schedule.planned_quantity}</td>
                                            <td>${schedule.actual_quantity || '-'}</td>
                                            <td><span class="badge ${getScheduleStatusBadgeClass(schedule.status)}">${getScheduleStatusText(schedule.status)}</span></td>
                                            <td>${schedule.notes || '-'}</td>
                                            <td>${formatDate(schedule.created_at)}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    ` : `
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i>
                            등록된 공급 일정이 없습니다.
                        </div>
                    `}
                </div>
            </div>
        `;
        
        const modal = new bootstrap.Modal(document.getElementById('orderDetailModal'));
        modal.show();
    } catch (error) {
        console.error('주문 상세 로드 실패:', error);
        alert('주문 상세 정보를 불러오는데 실패했습니다.');
    }
}

// 주문 상품 추가
function addOrderItem() {
    console.log('addOrderItem 호출됨, products 배열:', products);
    
    const tbody = document.getElementById('orderItemsTableBody');
    const emptyRow = document.getElementById('emptyRow');
    if (emptyRow) {
        emptyRow.remove();
    }
    
    if (!products || products.length === 0) {
        console.error('제품 목록이 비어있습니다. 제품을 먼저 로드해주세요.');
        alert('제품 목록을 불러오는 중입니다. 잠시 후 다시 시도해주세요.');
        return;
    }
    
    const row = document.createElement('tr');
    row.innerHTML = `
        <td>
            <select class="form-select form-select-sm" onchange="updateOrderItemPrice(this)">
                <option value="">제품 선택</option>
                ${products.map(product => `
                    <option value="${product.id}" data-price="${product.price}">${product.name}</option>
                `).join('')}
            </select>
        </td>
        <td><input type="number" class="form-control form-control-sm quantity-input" min="1" value="1" onchange="updateOrderItemTotal(this)"></td>
        <td><input type="number" class="form-control form-control-sm price-input" step="0.01" onchange="updateOrderItemTotal(this)"></td>
        <td><span class="order-item-total">0</span></td>
        <td><input type="text" class="form-control form-control-sm"></td>
        <td><button type="button" class="btn btn-outline-danger btn-sm" onclick="removeOrderItem(this)"><i class="fas fa-trash"></i></button></td>
    `;
    tbody.appendChild(row);
}

// 주문 상품 제거
function removeOrderItem(button) {
    const row = button.closest('tr');
    row.remove();
    
    const tbody = document.getElementById('orderItemsTableBody');
    if (tbody.children.length === 0) {
        tbody.innerHTML = '<tr id="emptyRow"><td colspan="6" class="text-center text-muted">주문 상품을 추가하세요</td></tr>';
    }
}

// 주문 상품 가격 업데이트
function updateOrderItemPrice(select) {
    const price = select.selectedOptions[0]?.dataset.price || 0;
    const row = select.closest('tr');
    const priceInput = row.querySelector('.price-input');
    
    if (priceInput) {
        priceInput.value = price;
        updateOrderItemTotal(priceInput);
    } else {
        console.error('가격 입력 필드를 찾을 수 없습니다.');
    }
}

// 주문 상품 총가격 업데이트
function updateOrderItemTotal(input) {
    const row = input.closest('tr');
    const quantityInput = row.querySelector('.quantity-input');
    const priceInput = row.querySelector('.price-input');
    
    if (!quantityInput || !priceInput) {
        console.error('수량 또는 가격 입력 필드를 찾을 수 없습니다.');
        return;
    }
    
    const quantity = parseFloat(quantityInput.value) || 0;
    const price = parseFloat(priceInput.value) || 0;
    const total = quantity * price;
    
    const totalSpan = row.querySelector('.order-item-total');
    if (totalSpan) {
        totalSpan.textContent = formatCurrency(total);
    }
}

// 주문 생성
async function createOrder() {
    const form = document.getElementById('createOrderForm');
    const formData = new FormData(form);
    
    // 주문 상품 수집
    const items = [];
    const tbody = document.getElementById('orderItemsTableBody');
    const rows = tbody.querySelectorAll('tr:not(#emptyRow)');
    
    for (const row of rows) {
        const productSelect = row.querySelector('select');
        const quantityInput = row.querySelector('.quantity-input');
        const priceInput = row.querySelector('.price-input');
        const notesInput = row.querySelector('input[type="text"]');
        
        if (productSelect && productSelect.value && quantityInput && quantityInput.value && priceInput && priceInput.value) {
            items.push({
                product_id: parseInt(productSelect.value),
                quantity: parseInt(quantityInput.value),
                unit_price: parseFloat(priceInput.value),
                notes: notesInput ? notesInput.value : null
            });
        }
    }
    
    if (items.length === 0) {
        alert('최소 하나의 주문 상품을 추가해주세요.');
        return;
    }
    
    // 총 금액 계산
    const totalAmount = items.reduce((sum, item) => sum + (item.quantity * item.unit_price), 0);
    
    // 폼 요소들 가져오기
    const supplierSelect = document.getElementById('supplierSelect');
    const deliveryDate = document.getElementById('deliveryDate');
    const currencySelect = document.getElementById('currencySelect');
    const prioritySelect = document.getElementById('prioritySelect');
    const paymentTypeSelect = document.getElementById('paymentTypeSelect');
    const orderNotes = document.getElementById('orderNotes');
    
    // 필수 필드 검증
    if (!supplierSelect || !supplierSelect.value) {
        alert('거래처를 선택해주세요.');
        return;
    }
    
    if (!currencySelect || !currencySelect.value) {
        alert('통화를 선택해주세요.');
        return;
    }
    
    if (!prioritySelect || !prioritySelect.value) {
        alert('우선순위를 선택해주세요.');
        return;
    }
    
    if (!paymentTypeSelect || !paymentTypeSelect.value) {
        alert('결제 방식을 선택해주세요.');
        return;
    }
    
    // 날짜 형식 처리
    let deliveryDateValue = null;
    if (deliveryDate && deliveryDate.value) {
        // ISO 형식으로 변환 (YYYY-MM-DD)
        deliveryDateValue = deliveryDate.value + 'T00:00:00';
    }
    
    const orderData = {
        supplier_id: parseInt(supplierSelect.value),
        delivery_date: deliveryDateValue,
        total_amount: totalAmount,
        currency: currencySelect.value,
        priority: prioritySelect.value,
        payment_type: paymentTypeSelect.value,
        notes: orderNotes ? orderNotes.value || null : null,
        items: items
    };
    
    console.log('주문 데이터:', orderData);
    
    try {
        const response = await fetch('/api/orders', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(orderData)
        });
        
        if (response.ok) {
            const result = await response.json();
            alert('주문이 성공적으로 생성되었습니다.');
            bootstrap.Modal.getInstance(document.getElementById('createOrderModal')).hide();
            form.reset();
            document.getElementById('orderItemsTableBody').innerHTML = '<tr id="emptyRow"><td colspan="6" class="text-center text-muted">주문 상품을 추가하세요</td></tr>';
            loadOrders();
        } else {
            const error = await response.json();
            alert('주문 생성 실패: ' + error.detail);
        }
    } catch (error) {
        console.error('주문 생성 실패:', error);
        alert('주문 생성 중 오류가 발생했습니다.');
    }
}


// 공급 일정 추가 모달 열기
async function addSupplyScheduleModal(orderId) {
    currentOrderId = orderId;
    document.getElementById('supplyScheduleOrderId').value = orderId;
    
    // 기존 일정 행들 초기화
    document.getElementById('scheduleRowsTableBody').innerHTML = '';
    
    // 첫 번째 일정 행 추가
    addScheduleRow();
    
    const modal = new bootstrap.Modal(document.getElementById('supplyScheduleModal'));
    modal.show();
}

// 일정 행 추가
async function addScheduleRow() {
    const tbody = document.getElementById('scheduleRowsTableBody');
    const rowIndex = tbody.children.length;
    
    // 주문 상세 정보 로드
    let orderItems = [];
    try {
        const response = await fetch(`/api/orders/${currentOrderId}`);
        if (response.ok) {
            const data = await response.json();
            orderItems = data.items;
        }
    } catch (error) {
        console.error('주문 정보 로드 실패:', error);
    }
    
    const row = document.createElement('tr');
    row.innerHTML = `
        <td>
            <input type="date" class="form-control form-control-sm schedule-date" required>
        </td>
        <td>
            <input type="text" class="form-control form-control-sm schedule-notes" placeholder="비고">
        </td>
        <td>
            <div class="schedule-items-container" data-row-index="${rowIndex}">
                ${orderItems.map(item => `
                    <div class="row mb-1">
                        <div class="col-6">
                            <small class="text-muted">${item.product_name}</small>
                        </div>
                        <div class="col-6">
                            <input type="number" 
                                   class="form-control form-control-sm schedule-quantity" 
                                   min="0" 
                                   max="${item.remaining_quantity}" 
                                   value="0"
                                   data-order-item-id="${item.id}"
                                   placeholder="계획 수량">
                        </div>
                    </div>
                `).join('')}
            </div>
        </td>
        <td>
            <button type="button" class="btn btn-outline-danger btn-sm" onclick="removeScheduleRow(this)">
                <i class="fas fa-trash"></i>
            </button>
        </td>
    `;
    tbody.appendChild(row);
}

// 일정 행 제거
function removeScheduleRow(button) {
    const row = button.closest('tr');
    row.remove();
}

// 공급 일정 추가
async function addSupplySchedule() {
    const scheduleRows = document.querySelectorAll('#scheduleRowsTableBody tr');
    
    if (scheduleRows.length === 0) {
        alert('최소 하나의 공급 일정을 추가해주세요.');
        return;
    }
    
    // 각 일정 행별로 처리
    for (let i = 0; i < scheduleRows.length; i++) {
        const row = scheduleRows[i];
        const scheduleDate = row.querySelector('.schedule-date').value;
        const notes = row.querySelector('.schedule-notes').value || null;
        
        if (!scheduleDate) {
            alert(`${i + 1}번째 일정의 공급 예정일을 선택해주세요.`);
            return;
        }
        
        // 품목별 계획 수량 수집
        const scheduleItems = [];
        const quantityInputs = row.querySelectorAll('.schedule-quantity');
        let hasValidQuantity = false;
        
        quantityInputs.forEach(input => {
            const quantity = parseInt(input.value) || 0;
            const maxQuantity = parseInt(input.max);
            const itemId = parseInt(input.dataset.orderItemId);
            
            if (quantity > 0) {
                if (quantity > maxQuantity) {
                    alert(`${i + 1}번째 일정: 계획 수량이 잔여 수량을 초과할 수 없습니다. (최대: ${maxQuantity})`);
                    return;
                }
                
                scheduleItems.push({
                    order_item_id: itemId,
                    planned_quantity: quantity
                });
                hasValidQuantity = true;
            }
        });
        
        if (!hasValidQuantity) {
            alert(`${i + 1}번째 일정: 최소 하나의 품목에 계획 수량을 입력해주세요.`);
            return;
        }
        
        const scheduleData = {
            schedule_date: scheduleDate,
            notes: notes,
            items: scheduleItems
        };
        
        try {
            const response = await fetch(`/api/orders/${currentOrderId}/supply-schedule`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(scheduleData)
            });
            
            if (!response.ok) {
                const error = await response.json();
                alert(`${i + 1}번째 일정 추가 실패: ${error.detail}`);
                return;
            }
        } catch (error) {
            console.error(`${i + 1}번째 일정 추가 실패:`, error);
            alert(`${i + 1}번째 일정 추가 중 오류가 발생했습니다.`);
            return;
        }
    }
    
    alert('모든 공급 일정이 성공적으로 추가되었습니다.');
    bootstrap.Modal.getInstance(document.getElementById('supplyScheduleModal')).hide();
    document.getElementById('supplyScheduleForm').reset();
    loadOrders(); // 주문 목록 새로고침
}


// 유틸리티 함수들
function formatCurrency(amount, currency = 'KRW') {
    if (currency === 'KRW') {
        return new Intl.NumberFormat('ko-KR').format(amount) + '원';
    }
    return new Intl.NumberFormat('en-US', { style: 'currency', currency }).format(amount);
}

function formatDate(dateString) {
    if (!dateString) return '-';
    const date = new Date(dateString);
    return date.toLocaleDateString('ko-KR', {
        timeZone: 'Asia/Seoul',
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit'
    });
}

function getStatusBadgeClass(status) {
    const classes = {
        'pending': 'bg-warning',
        'confirmed': 'bg-info',
        'in_progress': 'bg-primary',
        'completed': 'bg-success',
        'cancelled': 'bg-danger'
    };
    return classes[status] || 'bg-secondary';
}

function getStatusText(status) {
    const texts = {
        'pending': '대기중',
        'confirmed': '확정',
        'in_progress': '진행중',
        'completed': '완료',
        'cancelled': '취소'
    };
    return texts[status] || status;
}

// 공급 일정 상태 관련 함수들
function getScheduleStatusBadgeClass(status) {
    const classes = {
        'scheduled': 'bg-info',
        'in_progress': 'bg-primary',
        'completed': 'bg-success',
        'cancelled': 'bg-danger'
    };
    return classes[status] || 'bg-secondary';
}

function getScheduleStatusText(status) {
    const texts = {
        'scheduled': '예정',
        'in_progress': '진행중',
        'completed': '완료',
        'cancelled': '취소'
    };
    return texts[status] || status;
}


function getPriorityBadgeClass(priority) {
    const classes = {
        'low': 'bg-secondary',
        'normal': 'bg-primary',
        'high': 'bg-warning',
        'urgent': 'bg-danger'
    };
    return classes[priority] || 'bg-secondary';
}

function getPriorityText(priority) {
    const texts = {
        'low': '낮음',
        'normal': '보통',
        'high': '높음',
        'urgent': '긴급'
    };
    return texts[priority] || priority;
}

// 결제방식 관련 함수들
function getPaymentTypeBadgeClass(paymentType) {
    const classes = {
        'advance': 'bg-warning',
        'post': 'bg-info'
    };
    return classes[paymentType] || 'bg-secondary';
}

function getPaymentTypeText(paymentType) {
    const texts = {
        'advance': '선납',
        'post': '후납'
    };
    return texts[paymentType] || paymentType;
}

// 상태 변경 팝업 표시
let currentOrderStatus = null;

function showStatusPopup(orderId) {
    currentOrderId = orderId;
    
    // 현재 주문의 상태 찾기
    const order = orders.find(o => o.id === orderId);
    if (!order) {
        alert('주문 정보를 찾을 수 없습니다.');
        return;
    }
    
    currentOrderStatus = order.status;
    
    // 완료된 주문은 상태 변경 불가
    if (currentOrderStatus === 'completed') {
        alert('완료된 주문은 상태를 변경할 수 없습니다.');
        return;
    }
    
    // 팝업 내용 동적 생성
    const popupBody = document.getElementById('statusPopupBody');
    let content = '';
    
    // 상태 변경 옵션들
    content += `
        <button class="status-option" onclick="changeOrderStatus('confirmed')">
            <i class="fas fa-check-circle me-2 text-info"></i>확정
        </button>
        <button class="status-option" onclick="changeOrderStatus('in_progress')">
            <i class="fas fa-play-circle me-2 text-primary"></i>진행중
        </button>
        <button class="status-option" onclick="changeOrderStatus('completed')">
            <i class="fas fa-check-double me-2 text-success"></i>완료
        </button>
        <button class="status-option danger" onclick="changeOrderStatus('cancelled')">
            <i class="fas fa-times-circle me-2"></i>취소
        </button>
    `;
    
    // 취소된 주문에만 삭제 버튼 표시
    if (currentOrderStatus === 'cancelled') {
        content += `
            <hr class="my-1">
            <button class="status-option danger" onclick="deleteOrder()">
                <i class="fas fa-trash me-2"></i>주문 삭제
            </button>
        `;
    }
    
    popupBody.innerHTML = content;
    
    document.getElementById('statusPopupOverlay').classList.add('show');
    document.getElementById('statusPopup').classList.add('show');
}

// 상태 변경 팝업 숨기기
function hideStatusPopup() {
    document.getElementById('statusPopupOverlay').classList.remove('show');
    document.getElementById('statusPopup').classList.remove('show');
    currentOrderId = null;
    currentOrderStatus = null;
}

// 주문 상태 변경
async function changeOrderStatus(status) {
    if (!currentOrderId) {
        alert('주문 ID가 없습니다.');
        return;
    }
    
    if (!confirm(`주문 상태를 "${getStatusText(status)}"로 변경하시겠습니까?`)) {
        return;
    }
    
    try {
        const response = await fetch(`/api/orders/${currentOrderId}/status`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ status: status })
        });
        
        if (response.ok) {
            alert('주문 상태가 성공적으로 변경되었습니다.');
            hideStatusPopup();
            loadOrders(); // 주문 목록 새로고침
        } else {
            const error = await response.json();
            alert('주문 상태 변경 실패: ' + error.detail);
        }
    } catch (error) {
        console.error('주문 상태 변경 실패:', error);
        alert('주문 상태 변경 중 오류가 발생했습니다.');
    }
}

// 주문 삭제
async function deleteOrder() {
    if (!currentOrderId) {
        alert('주문 ID가 없습니다.');
        return;
    }
    
    if (!confirm('정말로 이 취소된 주문을 삭제하시겠습니까?\n\n삭제된 주문은 복구할 수 없습니다.')) {
        return;
    }
    
    // 추가 확인
    if (!confirm('마지막 확인입니다.\n\n취소된 주문과 관련된 모든 데이터(공급일정, 선납금 등)가 함께 삭제됩니다.\n\n정말 삭제하시겠습니까?')) {
        return;
    }
    
    try {
        const response = await fetch(`/api/orders/${currentOrderId}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
            }
        });
        
        if (response.ok) {
            alert('주문이 성공적으로 삭제되었습니다.');
            hideStatusPopup();
            loadOrders(); // 주문 목록 새로고침
        } else {
            const error = await response.json();
            alert('주문 삭제 실패: ' + error.detail);
        }
    } catch (error) {
        console.error('주문 삭제 실패:', error);
        alert('주문 삭제 중 오류가 발생했습니다.');
    }
}
</script>
{% endblock %}
