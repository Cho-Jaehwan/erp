{% extends "base.html" %}

{% block title %}거래처 관리 - 재고관리 시스템{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="mb-4">
            <i class="fas fa-handshake me-2"></i>거래처 관리
        </h1>
    </div>
</div>

<!-- 거래처 추가 버튼 -->
<div class="row mb-4">
    <div class="col-12">
        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#supplierModal">
            <i class="fas fa-plus me-2"></i>새 거래처 추가
        </button>
        <button type="button" class="btn btn-outline-secondary ms-2" id="toggleSortMode">
            <i class="fas fa-sort me-2"></i>정렬 모드
        </button>
        <button type="button" class="btn btn-success ms-2" id="saveSortOrder" style="display: none;">
            <i class="fas fa-save me-2"></i>정렬 순서 저장
        </button>
        <button type="button" class="btn btn-secondary ms-2" id="cancelSortMode" style="display: none;">
            <i class="fas fa-times me-2"></i>정렬 취소
        </button>
    </div>
</div>

<!-- 거래처 통계 -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card text-center">
            <div class="card-body">
                <h5 class="card-title text-success">입고처</h5>
                <h3 class="text-success" id="inSupplierCount">-</h3>
                <p class="card-text">총 입고 거래처 수</p>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card text-center">
            <div class="card-body">
                <h5 class="card-title text-warning">출고처</h5>
                <h3 class="text-warning" id="outSupplierCount">-</h3>
                <p class="card-text">총 출고 거래처 수</p>
            </div>
        </div>
    </div>
</div>

<!-- 거래처 목록 탭 -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <ul class="nav nav-tabs card-header-tabs" id="supplierTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="all-tab" data-bs-toggle="tab" data-bs-target="#all" type="button" role="tab">
                            <i class="fas fa-list me-2"></i>전체 거래처
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="in-tab" data-bs-toggle="tab" data-bs-target="#in" type="button" role="tab">
                            <i class="fas fa-arrow-down me-2"></i>입고처
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="out-tab" data-bs-toggle="tab" data-bs-target="#out" type="button" role="tab">
                            <i class="fas fa-arrow-up me-2"></i>출고처
                        </button>
                    </li>
                </ul>
            </div>
            <div class="card-body">
                <div class="tab-content" id="supplierTabContent">
                    <!-- 전체 거래처 탭 -->
                    <div class="tab-pane fade show active" id="all" role="tabpanel">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th class="sort-handle-column" style="display: none;">순서</th>
                                        <th>거래처명</th>
                                        <th>유형</th>
                                        <th>담당자</th>
                                        <th>연락처</th>
                                        <th>이메일</th>
                                        <th>상태</th>
                                        <th>등록일</th>
                                        <th>작업</th>
                                    </tr>
                                </thead>
                                <tbody id="allSuppliersTable">
                                    <!-- 전체 거래처 목록이 여기에 동적으로 로드됩니다 -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- 입고처 탭 -->
                    <div class="tab-pane fade" id="in" role="tabpanel">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th class="sort-handle-column" style="display: none;">순서</th>
                                        <th>거래처명</th>
                                        <th>담당자</th>
                                        <th>연락처</th>
                                        <th>이메일</th>
                                        <th>상태</th>
                                        <th>등록일</th>
                                        <th>작업</th>
                                    </tr>
                                </thead>
                                <tbody id="inSuppliersTable">
                                    <!-- 입고처 목록이 여기에 동적으로 로드됩니다 -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- 출고처 탭 -->
                    <div class="tab-pane fade" id="out" role="tabpanel">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th class="sort-handle-column" style="display: none;">순서</th>
                                        <th>거래처명</th>
                                        <th>담당자</th>
                                        <th>연락처</th>
                                        <th>이메일</th>
                                        <th>상태</th>
                                        <th>등록일</th>
                                        <th>작업</th>
                                    </tr>
                                </thead>
                                <tbody id="outSuppliersTable">
                                    <!-- 출고처 목록이 여기에 동적으로 로드됩니다 -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 거래처 추가/수정 모달 -->
<div class="modal fade" id="supplierModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="supplierModalTitle">새 거래처 추가</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="supplierForm">
                    <input type="hidden" id="supplierId" name="id">
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="supplierName" class="form-label">거래처명 *</label>
                                <input type="text" class="form-control" id="supplierName" name="name" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="supplierType" class="form-label">거래처 분류 *</label>
                                <select class="form-select" id="supplierType" name="supplier_type" required>
                                    <option value="">분류를 선택하세요</option>
                                    <option value="in">입고처 (재고를 공급받는 거래처)</option>
                                    <option value="out">출고처 (재고를 공급하는 거래처)</option>
                                </select>
                                <div class="form-text">
                                    <small class="text-muted">
                                        <i class="fas fa-info-circle me-1"></i>
                                        입고처는 재고를 구매하는 곳, 출고처는 재고를 판매하는 곳입니다.
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="contactPerson" class="form-label">작업자</label>
                                <input type="text" class="form-control" id="contactPerson" name="contact_person">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="phone" class="form-label">연락처</label>
                                <input type="tel" class="form-control" id="phone" name="phone">
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="email" class="form-label">이메일</label>
                        <input type="email" class="form-control" id="email" name="email">
                    </div>
                    
                    <div class="mb-3">
                        <label for="address" class="form-label">주소</label>
                        <textarea class="form-control" id="address" name="address" rows="3"></textarea>
                    </div>
                    
                    <div class="mb-3" id="statusField" style="display: none;">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="isActive" name="is_active" checked>
                            <label class="form-check-label" for="isActive">
                                활성 상태
                            </label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                <button type="button" class="btn btn-primary" id="saveSupplier">저장</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<script>
    let suppliers = [];
    let editingSupplierId = null;
    let isSortMode = false;
    let originalSortOrder = {};

    // 날짜 포맷팅 함수
    function formatDate(dateString) {
        if (!dateString || dateString === 'null' || dateString === 'undefined') {
            return '-';
        }
        
        try {
            const date = new Date(dateString);
            if (isNaN(date.getTime())) {
                console.warn('Invalid date:', dateString);
                return '-';
            }
            return date.toLocaleDateString('ko-KR');
        } catch (error) {
            console.error('Date formatting error:', error, 'Input:', dateString);
            return '-';
        }
    }

    // 페이지 로드 시 거래처 목록 로드
    document.addEventListener('DOMContentLoaded', function() {
        loadSuppliers();
    });

    // 거래처 목록 로드
    async function loadSuppliers() {
        try {
            const response = await fetch('/api/suppliers', {
                credentials: 'include'
            });
            
            if (response.ok) {
                const data = await response.json();
                console.log('Suppliers API response:', data);
                suppliers = data.suppliers || [];
                console.log('Suppliers array:', suppliers);
                renderSuppliersTable();
            } else {
                alert('거래처 목록을 불러오는데 실패했습니다.');
            }
        } catch (error) {
            console.error('Error loading suppliers:', error);
            alert('거래처 목록을 불러오는데 실패했습니다.');
        }
    }

    // 거래처 테이블 렌더링
    function renderSuppliersTable() {
        // 통계 업데이트
        const inSuppliers = suppliers.filter(s => s.supplier_type === 'in');
        const outSuppliers = suppliers.filter(s => s.supplier_type === 'out');
        
        document.getElementById('inSupplierCount').textContent = inSuppliers.length;
        document.getElementById('outSupplierCount').textContent = outSuppliers.length;

        // 전체 거래처 테이블 렌더링
        renderTable('allSuppliersTable', suppliers, true);
        
        // 입고처 테이블 렌더링
        renderTable('inSuppliersTable', inSuppliers, false);
        
        // 출고처 테이블 렌더링
        renderTable('outSuppliersTable', outSuppliers, false);
    }

    // 테이블 렌더링 헬퍼 함수
    function renderTable(tableId, supplierList, showType = false) {
        const tbody = document.getElementById(tableId);
        tbody.innerHTML = '';

        supplierList.forEach(supplier => {
            const row = document.createElement('tr');
            row.setAttribute('data-supplier-id', supplier.id);
            row.setAttribute('data-supplier-type', supplier.supplier_type);
            
            let typeColumn = '';
            let sortHandleColumn = '';
            
            if (isSortMode) {
                sortHandleColumn = `
                    <td class="sort-handle-column">
                        <i class="fas fa-grip-vertical text-muted" style="cursor: move;"></i>
                    </td>
                `;
            }
            
            if (showType) {
                typeColumn = `
                    <td>
                        <span class="badge ${supplier.supplier_type === 'in' ? 'bg-success' : 'bg-warning'}">
                            ${supplier.supplier_type === 'in' ? '입고처' : '출고처'}
                        </span>
                    </td>
                `;
            }
            
            row.innerHTML = `
                ${sortHandleColumn}
                <td>${supplier.name}</td>
                ${typeColumn}
                <td>${supplier.contact_person || '-'}</td>
                <td>${supplier.phone || '-'}</td>
                <td>${supplier.email || '-'}</td>
                <td>
                    <span class="badge ${supplier.is_active ? 'bg-success' : 'bg-secondary'}">
                        ${supplier.is_active ? '활성' : '비활성'}
                    </span>
                </td>
                <td>${formatDate(supplier.created_at)}</td>
                <td>
                    <button class="btn btn-sm btn-outline-primary me-1" onclick="editSupplier(${supplier.id})" ${isSortMode ? 'disabled' : ''}>
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-danger" onclick="deleteSupplier(${supplier.id})" ${isSortMode ? 'disabled' : ''}>
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            `;
            tbody.appendChild(row);
        });
        
        // 정렬 모드일 때 Sortable 초기화
        if (isSortMode) {
            initializeSortable(tableId);
        }
    }

    // 거래처 추가/수정 모달 열기
    function openSupplierModal(supplier = null) {
        const modal = new bootstrap.Modal(document.getElementById('supplierModal'));
        const form = document.getElementById('supplierForm');
        const title = document.getElementById('supplierModalTitle');
        const statusField = document.getElementById('statusField');

        form.reset();
        editingSupplierId = null;

        if (supplier) {
            // 수정 모드
            title.textContent = '거래처 수정';
            statusField.style.display = 'block';
            editingSupplierId = supplier.id;
            
            document.getElementById('supplierId').value = supplier.id;
            document.getElementById('supplierName').value = supplier.name;
            document.getElementById('supplierType').value = supplier.supplier_type;
            document.getElementById('contactPerson').value = supplier.contact_person || '';
            document.getElementById('phone').value = supplier.phone || '';
            document.getElementById('email').value = supplier.email || '';
            document.getElementById('address').value = supplier.address || '';
            document.getElementById('isActive').checked = supplier.is_active;
        } else {
            // 추가 모드
            title.textContent = '새 거래처 추가';
            statusField.style.display = 'none';
        }

        modal.show();
    }

    // 거래처 수정
    function editSupplier(id) {
        const supplier = suppliers.find(s => s.id === id);
        if (supplier) {
            openSupplierModal(supplier);
        }
    }

    // 거래처 삭제
    async function deleteSupplier(id) {
        if (confirm('정말로 이 거래처를 삭제하시겠습니까?')) {
            try {
                const response = await fetch(`/api/suppliers/${id}`, {
                    method: 'DELETE',
                    credentials: 'include'
                });

                if (response.ok) {
                    alert('거래처가 삭제되었습니다.');
                    loadSuppliers();
                } else {
                    const error = await response.json();
                    alert(error.detail || '거래처 삭제에 실패했습니다.');
                }
            } catch (error) {
                console.error('Error deleting supplier:', error);
                alert('거래처 삭제에 실패했습니다.');
            }
        }
    }

    // 거래처 저장
    document.getElementById('saveSupplier').addEventListener('click', async function() {
        const form = document.getElementById('supplierForm');
        const formData = new FormData(form);
        
        const supplierData = {
            name: formData.get('name'),
            supplier_type: formData.get('supplier_type'),
            contact_person: formData.get('contact_person') || null,
            phone: formData.get('phone') || null,
            email: formData.get('email') || null,
            address: formData.get('address') || null
        };

        if (editingSupplierId) {
            supplierData.is_active = formData.get('is_active') === 'on';
        }

        try {
            const url = editingSupplierId ? `/api/suppliers/${editingSupplierId}` : '/api/suppliers';
            const method = editingSupplierId ? 'PUT' : 'POST';
            
            const response = await fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json'
                },
                credentials: 'include',
                body: JSON.stringify(supplierData)
            });

            if (response.ok) {
                alert(editingSupplierId ? '거래처가 수정되었습니다.' : '거래처가 추가되었습니다.');
                bootstrap.Modal.getInstance(document.getElementById('supplierModal')).hide();
                loadSuppliers();
            } else {
                const error = await response.json();
                alert(error.detail || '거래처 저장에 실패했습니다.');
            }
        } catch (error) {
            console.error('Error saving supplier:', error);
            alert('거래처 저장에 실패했습니다.');
        }
    });

    // 모달이 닫힐 때 폼 리셋
    document.getElementById('supplierModal').addEventListener('hidden.bs.modal', function() {
        document.getElementById('supplierForm').reset();
        editingSupplierId = null;
    });

    // 정렬 모드 토글
    document.getElementById('toggleSortMode').addEventListener('click', function() {
        toggleSortMode();
    });

    // 정렬 순서 저장
    document.getElementById('saveSortOrder').addEventListener('click', function() {
        saveSortOrder();
    });

    // 정렬 취소
    document.getElementById('cancelSortMode').addEventListener('click', function() {
        cancelSortMode();
    });

    // 정렬 모드 토글 함수
    function toggleSortMode() {
        isSortMode = !isSortMode;
        
        if (isSortMode) {
            // 정렬 모드 진입
            document.getElementById('toggleSortMode').style.display = 'none';
            document.getElementById('saveSortOrder').style.display = 'inline-block';
            document.getElementById('cancelSortMode').style.display = 'inline-block';
            
            // 원본 정렬 순서 저장
            originalSortOrder = {};
            suppliers.forEach(supplier => {
                originalSortOrder[supplier.id] = supplier.sort_order || 0;
            });
            
            // 정렬 핸들 컬럼 표시
            document.querySelectorAll('.sort-handle-column').forEach(col => {
                col.style.display = 'table-cell';
            });
            
            // 테이블 다시 렌더링
            renderSuppliersTable();
            
            // 탭 전환 이벤트 리스너 추가
            document.querySelectorAll('#supplierTabs button[data-bs-toggle="tab"]').forEach(tab => {
                tab.addEventListener('shown.bs.tab', function() {
                    if (isSortMode) {
                        renderSuppliersTable();
                    }
                });
            });
        } else {
            // 정렬 모드 종료
            exitSortMode();
        }
    }

    // 정렬 모드 종료
    function exitSortMode() {
        isSortMode = false;
        document.getElementById('toggleSortMode').style.display = 'inline-block';
        document.getElementById('saveSortOrder').style.display = 'none';
        document.getElementById('cancelSortMode').style.display = 'none';
        
        // 정렬 핸들 컬럼 숨기기
        document.querySelectorAll('.sort-handle-column').forEach(col => {
            col.style.display = 'none';
        });
        
        // 탭 이벤트 리스너 제거
        document.querySelectorAll('#supplierTabs button[data-bs-toggle="tab"]').forEach(tab => {
            tab.removeEventListener('shown.bs.tab', function() {
                if (isSortMode) {
                    renderSuppliersTable();
                }
            });
        });
        
        // 테이블 다시 렌더링
        renderSuppliersTable();
    }

    // 정렬 취소
    function cancelSortMode() {
        // 원본 정렬 순서로 복원
        suppliers.forEach(supplier => {
            supplier.sort_order = originalSortOrder[supplier.id] || 0;
        });
        
        exitSortMode();
    }

    // Sortable 초기화
    function initializeSortable(tableId) {
        const tbody = document.getElementById(tableId);
        if (tbody) {
            new Sortable(tbody, {
                handle: '.sort-handle-column',
                animation: 150,
                ghostClass: 'sortable-ghost',
                chosenClass: 'sortable-chosen',
                dragClass: 'sortable-drag',
                onEnd: function(evt) {
                    // 정렬 순서 업데이트
                    updateSortOrder(tableId);
                }
            });
        }
    }

    // 정렬 순서 업데이트
    function updateSortOrder(tableId) {
        const tbody = document.getElementById(tableId);
        const rows = tbody.querySelectorAll('tr[data-supplier-id]');
        
        rows.forEach((row, index) => {
            const supplierId = parseInt(row.getAttribute('data-supplier-id'));
            const supplierType = row.getAttribute('data-supplier-type');
            const supplier = suppliers.find(s => s.id === supplierId);
            if (supplier) {
                // 타입별로 독립적인 정렬 순서 설정
                if (supplierType === 'in') {
                    // 입고처의 경우 입고처 내에서의 순서
                    const inSuppliers = suppliers.filter(s => s.supplier_type === 'in');
                    const inIndex = Array.from(rows).indexOf(row);
                    supplier.sort_order = inIndex + 1;
                } else if (supplierType === 'out') {
                    // 출고처의 경우 출고처 내에서의 순서
                    const outSuppliers = suppliers.filter(s => s.supplier_type === 'out');
                    const outIndex = Array.from(rows).indexOf(row);
                    supplier.sort_order = outIndex + 1;
                }
            }
        });
        
        console.log('Updated suppliers sort order:', suppliers.map(s => ({id: s.id, name: s.name, type: s.supplier_type, sort_order: s.sort_order})));
    }

    // 정렬 순서 저장
    async function saveSortOrder() {
        try {
            // 각 타입별로 정렬 순서 수집
            const sortOrders = {};
            
            // 현재 표시된 테이블에서 실제 순서를 가져오기
            const activeTab = document.querySelector('.nav-link.active');
            const activeTabId = activeTab ? activeTab.getAttribute('data-bs-target').replace('#', '') : 'all';
            
            if (activeTabId === 'all') {
                // 전체 탭의 경우 타입별로 순서 수집
                const inSuppliers = suppliers.filter(s => s.supplier_type === 'in').sort((a, b) => (a.sort_order || 0) - (b.sort_order || 0));
                const outSuppliers = suppliers.filter(s => s.supplier_type === 'out').sort((a, b) => (a.sort_order || 0) - (b.sort_order || 0));
                
                inSuppliers.forEach((supplier, index) => {
                    sortOrders[supplier.id] = index + 1;
                });
                
                outSuppliers.forEach((supplier, index) => {
                    sortOrders[supplier.id] = index + 1;
                });
            } else if (activeTabId === 'in') {
                // 입고처 탭의 경우
                const inTable = document.getElementById('inSuppliersTable');
                const rows = inTable.querySelectorAll('tr[data-supplier-id]');
                rows.forEach((row, index) => {
                    const supplierId = parseInt(row.getAttribute('data-supplier-id'));
                    sortOrders[supplierId] = index + 1;
                });
            } else if (activeTabId === 'out') {
                // 출고처 탭의 경우
                const outTable = document.getElementById('outSuppliersTable');
                const rows = outTable.querySelectorAll('tr[data-supplier-id]');
                rows.forEach((row, index) => {
                    const supplierId = parseInt(row.getAttribute('data-supplier-id'));
                    sortOrders[supplierId] = index + 1;
                });
            }
            
            // 새로운 스키마에 맞게 데이터 구성
            const requestData = {
                sort_orders: sortOrders
            };
            
            console.log('Sending sort order data:', requestData);
            
            const response = await fetch('/api/suppliers/update-sort-order', {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                credentials: 'include',
                body: JSON.stringify(requestData)
            });

            console.log('Response status:', response.status);

            if (response.ok) {
                alert('거래처 정렬 순서가 저장되었습니다.');
                exitSortMode();
                loadSuppliers(); // 목록 새로고침
            } else {
                const errorText = await response.text();
                console.error('Error response:', errorText);
                try {
                    const error = JSON.parse(errorText);
                    alert(error.detail || '정렬 순서 저장에 실패했습니다.');
                } catch (parseError) {
                    alert('정렬 순서 저장에 실패했습니다: ' + errorText);
                }
            }
        } catch (error) {
            console.error('Error saving sort order:', error);
            alert('정렬 순서 저장에 실패했습니다.');
        }
    }
</script>

<style>
.sortable-ghost {
    opacity: 0.4;
}

.sortable-chosen {
    background-color: #f8f9fa;
}

.sortable-drag {
    background-color: #e3f2fd;
}

.sort-handle-column {
    width: 50px;
    text-align: center;
}
</style>
{% endblock %}
